{% extends "base.html" %}

{% block content %}
  <section class="detail-card">
    <h3>Opening {{ diagram_label }}â€¦</h3>
    <p class="note">Preparing the scene in local storage and redirecting.</p>
  </section>
  <script>
    (async () => {
      const response = await fetch("{{ scene_api_url }}", { credentials: "same-origin" });
      if (!response.ok) {
        window.location.href = "{{ diagram_url }}";
        return;
      }
      const scene = await response.json();
      const payload = {
        elements: scene.elements || [],
        appState: scene.appState || {},
      };
      try {
        localStorage.setItem("{{ diagram_storage_key }}", JSON.stringify(payload.elements));
        localStorage.setItem("{{ diagram_state_key }}", JSON.stringify(payload.appState));
        localStorage.setItem("{{ diagram_version_key }}", JSON.stringify(Date.now()));
      } catch (err) {
        console.error(err);
      }
      window.location.href = "{{ diagram_url }}";
    })();
  </script>
{% endblock %}

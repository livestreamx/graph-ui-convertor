{% extends "base.html" %}

{% block content %}
  <section class="detail-card">
    <h3>Opening {{ diagram_label }}â€¦</h3>
    <p class="note">Preparing the scene in local storage and redirecting.</p>
  </section>
  <script>
    (async () => {
      const sceneApiUrl = {{ scene_api_url | tojson }};
      const diagramUrl = {{ diagram_url | tojson }};
      const diagramStorageKey = {{ diagram_storage_key | tojson }};
      const diagramStateKey = {{ diagram_state_key | tojson }};
      const diagramVersionKey = {{ diagram_version_key | tojson }};

      const response = await fetch(sceneApiUrl, { credentials: "same-origin" });
      if (!response.ok) {
        window.location.href = diagramUrl;
        return;
      }
      const scene = await response.json();
      const payload = {
        elements: scene.elements || [],
        appState: scene.appState || {},
      };
      try {
        localStorage.setItem(diagramStorageKey, JSON.stringify(payload.elements));
        localStorage.setItem(diagramStateKey, JSON.stringify(payload.appState));
        localStorage.setItem(diagramVersionKey, JSON.stringify(Date.now()));
      } catch (err) {
        console.error(err);
      }
      window.location.href = diagramUrl;
    })();
  </script>
{% endblock %}

{% extends "base.html" %}

{% block content %}
  <section class="detail-header">
    <a class="ghost-button" href="/catalog?lang={{ lang }}">{{ t("Back to catalog") }}</a>
    <div class="detail-title">{{ item.title }}</div>
    <div class="detail-meta">
      <span>{{ "markup_type" | humanize_text }}: {{ item.markup_type | humanize_text }}</span>
      <span>{{ t("Updated") }} {{ item.updated_at | msk_datetime }}</span>
      <span>{{ t("Scene ID") }} {{ item.scene_id }}</span>
    </div>
    {% if item.tags %}
      <div class="tag-row">
        {% for tag in item.tags %}
          <span class="tag">{{ tag }}</span>
        {% endfor %}
      </div>
    {% endif %}
  </section>

  <section class="detail-grid">
    <div class="detail-card">
      <h3>{{ t("Open the diagram") }}</h3>
      <p>
        {{ t("Open in Excalidraw or download both diagram formats for manual import and editing.") }}
      </p>
      <div class="button-row">
        {% if diagram_excalidraw_enabled %}
          <a class="primary-button" target="_blank" href="{{ excalidraw_open_url }}">{{ t("Open Excalidraw") }}</a>
        {% endif %}
        <a class="ghost-button" href="/api/scenes/{{ item.scene_id }}?format=excalidraw&download=true">
          {{ t("Download .excalidraw") }}
        </a>
        <a class="ghost-button unidraw-button" href="/api/scenes/{{ item.scene_id }}?format=unidraw&download=true">
          {{ t("Download .unidraw") }}
        </a>
      </div>
      {% if not excalidraw_scene_available %}
        {% if on_demand_enabled %}
          <p class="note">{{ t("Scene will be generated on demand from markup.") }}</p>
        {% else %}
          <p class="note">
            {{ t("Scene file not found in {dir_name}. Run build-all before opening.", dir_name=excalidraw_dir_label) }}
          </p>
        {% endif %}
      {% elif open_mode == "manual" %}
        <p class="note">{{ t("Scene is too large for URL sharing. Use Download + Import.") }}</p>
      {% elif open_mode == "local_storage" %}
        <p class="note">{{ t("Scene is injected via local storage for same-origin Excalidraw.") }}</p>
      {% else %}
        <p class="note">{{ t("If the scene does not load, import the downloaded file manually.") }}</p>
      {% endif %}
    </div>
  </section>

  <section class="detail-card">
    <h3>{{ t("Metadata snapshot") }}</h3>
    <div class="meta-grid">
      <div>
        <div class="meta-label">{{ t("Markup file") }}</div>
        <div class="meta-value">{{ item.markup_rel_path }}</div>
      </div>
      <div>
        <div class="meta-label">{{ t("Excalidraw file") }}</div>
        <div class="meta-value">{{ excalidraw_rel_path }}</div>
      </div>
      <div>
        <div class="meta-label">{{ t("Unidraw file") }}</div>
        <div class="meta-value">{{ unidraw_rel_path }}</div>
      </div>
      <div>
        <div class="meta-label">{{ t("FineDog unit") }}</div>
        <div class="meta-value">{{ item.finedog_unit_id }}</div>
      </div>
      <div>
        <div class="meta-label">{{ "criticality_level" | humanize_text }}</div>
        <div class="meta-value">{{ item.criticality_level | humanize_text }}</div>
      </div>
      <div>
        <div class="meta-label">{{ "team_id" | humanize_text }}</div>
        <div class="meta-value">{{ item.team_name }}</div>
      </div>
    </div>
    {% if item.markup_meta %}
      <div class="meta-grid meta-extra">
        {% for key, value in item.markup_meta.items() %}
          <div>
            <div class="meta-label">{{ key | humanize_text }}</div>
            <div class="meta-value">{{ value }}</div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </section>
{% endblock %}

{% extends "base.html" %}

{% macro render_team_service_entity(label, extra_class="", colorize=false) %}
  {% set parts = label.split(' / ') %}
  {% set team_name = parts[0] if parts|length > 0 else label %}
  {% set markup_type = parts[1] if parts|length > 2 else '' %}
  {% if parts|length > 2 %}
    {% set service_name = parts[2:] | join(' / ') %}
  {% elif parts|length > 1 %}
    {% set service_name = parts[1:] | join(' / ') %}
  {% else %}
    {% set service_name = label %}
  {% endif %}
  <span class="team-graph-graph-entity {{ extra_class }}" data-team="{{ team_name }}" {% if colorize %}data-colorize-team="true"{% endif %}>
    <span class="team-graph-graph-entity-team">{{ team_name }}</span>
    {% if markup_type %}
      <span class="team-graph-graph-entity-type">{{ markup_type | humanize_text }}</span>
    {% endif %}
    <span class="team-graph-graph-entity-service">
      {{ service_name }}
    </span>
  </span>
{% endmacro %}

{% macro render_graph_label_entities(label, extra_class="", force_colorize=false) %}
  {% set entities = label.split(' + ') %}
  <span class="team-graph-graph-entities {{ extra_class }}">
    {% for entity in entities %}
      {{ render_team_service_entity(entity, "team-graph-graph-entity-sm", colorize=force_colorize or entities|length > 1) }}
      {% if not loop.last %}
        <span class="team-graph-graph-separator" aria-hidden="true">x</span>
      {% endif %}
    {% endfor %}
  </span>
{% endmacro %}

{% macro render_procedure_caption(procedure_name, procedure_id, order_prefix="") %}
  <span class="team-graph-procedure-caption">
    <span class="team-graph-procedure-primary">
      {% if order_prefix %}
        <span class="team-graph-procedure-order">{{ order_prefix }}</span>
      {% endif %}
      {{ procedure_name or procedure_id }}
    </span>
    {% if procedure_name %}
      <span class="team-graph-procedure-id team-graph-mono">{{ procedure_id }}</span>
    {% endif %}
  </span>
{% endmacro %}

{% block content %}
  <section class="detail-header">
    <a class="ghost-button" href="/catalog?lang={{ lang }}">{{ t("Back to catalog") }}</a>
    <div class="detail-title">{{ t("Cross-team graphs builder") }}</div>
    <div class="detail-meta">
      <span>{{ t("Build combined procedure graphs across selected teams.") }}</span>
    </div>
  </section>

  <section class="team-graph-page" id="team-graph-page">
    <div class="detail-card team-graph-card">
      <div class="team-graph-header">
        <div>
          <h3>{{ t("Step 1. Select teams") }}</h3>
          <p class="team-graph-subtitle">
            {{ t("Select teams to merge their procedure_graph into a single overview.") }}
          </p>
        </div>
        <div class="team-graph-header-actions">
          <div class="team-graph-help">
            <button class="team-graph-help-button" type="button" aria-label="Teams in graph">?</button>
            <div class="team-graph-help-popover">
              <div class="team-graph-help-title">{{ t("Teams in graph") }}</div>
              {% if selected_teams %}
                <div class="team-graph-summary">
                  <div class="team-graph-summary-item">
                    <span class="team-graph-summary-value">{{ selected_team_count }}</span>
                    <span class="team-graph-summary-label">{{ t("teams") }}</span>
                  </div>
                  <div class="team-graph-summary-item">
                    <span class="team-graph-summary-value">{{ selected_markups_count }}</span>
                    <span class="team-graph-summary-label">{{ t("markups merged") }}</span>
                  </div>
                </div>
              {% endif %}
              <div class="team-chip-grid team-chip-grid-compact">
                {% if selected_teams %}
                  {% for team in selected_teams %}
                    <div class="team-chip">
                      <div class="team-chip-name">{{ team.label }}</div>
                      <div class="team-chip-id">{{ team.id }}</div>
                      <div class="team-chip-count">
                        {{ team.markup_count }} {{ t("markups") }}
                      </div>
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="team-chip-empty">{{ t("Select teams to build a combined graph.") }}</div>
                {% endif %}
              </div>
              <div class="team-graph-help-hint">
                {{ t("Builds a procedure-level graph using procedure_graph across selected teams.") }}
                {{ t("Disabled teams are fully omitted from builder analytics.") }}
              </div>
            </div>
          </div>
        </div>
      </div>
      <form
        class="team-graph-form"
        id="team-graph-form"
        action="/catalog/teams/graph"
        method="get"
        hx-get="/catalog/teams/graph"
        hx-target="#team-graph-page"
        hx-select="#team-graph-page"
        hx-swap="outerHTML"
        hx-push-url="true"
        hx-indicator="#team-graph-merge-loader"
      >
        <div class="team-graph-select-toolbar">
          <div class="team-graph-select-toolbar-spacer"></div>
          <button
            class="ghost-button team-graph-select-toggle"
            type="button"
            data-exclude-toggle
            aria-expanded="{% if disabled_team_count %}true{% else %}false{% endif %}"
          >
            {% if disabled_team_count %}{{ t("Hide disabled teams") }}{% else %}{{ t("Disable teams") }}{% endif %}
          </button>
        </div>
        <div
          class="team-graph-select-grid {% if not disabled_team_count %}is-collapsed{% endif %}"
          data-exclude-grid
        >
          <div class="team-graph-select-group">
            <div class="team-graph-select-header">
              <div class="team-graph-select-title">{{ t("Teams to merge") }}</div>
              <div class="team-graph-select-hint">
                {{ t("Included in graph build and analytics.") }}
              </div>
            </div>
            <label class="filter-control">
              <select id="team-graph-select" multiple size="8" form="team-graph-form">
                {% for team_key, team_label in team_options %}
                  <option
                    value="{{ team_key }}"
                    data-markups="{{ team_counts.get(team_key, 0) }}"
                    {% if team_key in team_ids %}selected{% endif %}
                  >
                    {{ team_label }}
                  </option>
                {% endfor %}
              </select>
            </label>
            <div class="team-graph-select-summary">
              <span class="team-graph-select-summary-value" data-summary-value="included-teams">
                {{ selected_team_count }}
              </span>
              <span class="team-graph-select-summary-label">{{ t("included teams") }}</span>
              <span class="team-graph-select-summary-muted">
                路
                <span data-summary-value="included-markups">
                  {{ selected_markups_count }}
                </span>
                {{ t("markups") }}
              </span>
            </div>
          </div>
          <div
            class="team-graph-select-group team-graph-select-group-muted {% if not disabled_team_count %}is-collapsed{% endif %}"
            data-exclude-panel
          >
            <div class="team-graph-select-header">
              <div class="team-graph-select-title">{{ t("Disable teams from analytics") }}</div>
              <div class="team-graph-select-hint">
                {{ t("Ignored in all builder metrics, merge-node detection, and overlap stats.") }}
              </div>
            </div>
            <div class="team-graph-select-body">
              <label class="filter-control">
                <select id="team-graph-exclude-select" multiple size="6" form="team-graph-form">
                  {% for team_key, team_label in all_team_options %}
                    <option
                      value="{{ team_key }}"
                      data-markups="{{ all_team_counts.get(team_key, 0) }}"
                      {% if team_key in disabled_team_ids %}selected{% endif %}
                    >
                      {{ team_label }}
                    </option>
                  {% endfor %}
                </select>
              </label>
              <div class="team-graph-select-summary">
                <span class="team-graph-select-summary-value" data-summary-value="disabled-teams">
                  {{ disabled_team_count }}
                </span>
                <span class="team-graph-select-summary-label">{{ t("disabled teams") }}</span>
                <span class="team-graph-select-summary-muted">
                  路
                  <span data-summary-value="disabled-markups">
                    {{ disabled_markups_count }}
                  </span>
                  {{ t("markups") }}
                </span>
              </div>
            </div>
          </div>
        </div>
        <input
          type="hidden"
          id="team-graph-input"
          name="team_ids"
          value="{{ team_ids | join(',') }}"
        />
        <input
          type="hidden"
          id="team-graph-exclude-input"
          name="excluded_team_ids"
          value="{{ disabled_team_ids | join(',') }}"
        />
        <input type="hidden" name="lang" value="{{ lang }}" />
      </form>
    </div>

    <div class="detail-card team-graph-flags-card">
      <div class="team-graph-flags-header">
        <h3>{{ t("Step 2. Feature flags") }}</h3>
        <p class="team-graph-subtitle">
          {{ t("Tune how selected markups render and how merge nodes are detected.") }}
        </p>
      </div>
      <div class="team-graph-merge-threshold-card">
        <div class="team-graph-merge-threshold-header">
          <div class="team-graph-merge-threshold-title-row">
            <div class="team-graph-merge-threshold-title">
              {{ t("Merge node chain threshold") }}
            </div>
            <div class="team-graph-help team-graph-help-inline team-graph-merge-threshold-help">
              <button
                class="team-graph-help-button team-graph-help-button-sm"
                type="button"
                aria-label="Merge chain threshold help"
              >
                ?
              </button>
              <div class="team-graph-help-popover team-graph-help-popover-wide">
                <div class="team-graph-help-title">{{ t("How merge chain threshold works") }}</div>
                <div class="team-graph-help-hint">
                  {{ t("Selects the minimum size of consecutive shared procedures to count as one merge chain.") }}
                </div>
                <ul class="team-graph-merge-threshold-rules">
                  <li>{{ t("0: merge node detection is fully disabled.") }}</li>
                  <li>{{ t("1: each shared procedure is treated as a merge node.") }}</li>
                  <li>
                    {{ t("N > 1: only non-overlapping strictly linear chains of at least N shared procedures are counted.") }}
                  </li>
                  <li>{{ t("Cycles are excluded from merge-chain detection.") }}</li>
                  <li>
                    {{ t("Branch/fork and join procedures are treated as chain boundaries for N > 1.") }}
                  </li>
                </ul>
              </div>
            </div>
          </div>
          <div class="team-graph-merge-threshold-value">
            <span data-merge-threshold-value>{{ merge_node_min_chain_size }}</span>
            <span data-merge-threshold-value-unit>
              {% if merge_node_min_chain_size == 1 %}{{ t("node") }}{% else %}{{ t("nodes") }}{% endif %}
            </span>
          </div>
        </div>
        <div class="team-graph-merge-threshold-text" data-merge-threshold-text>
          {% if merge_node_min_chain_size == 0 %}
            {{ t("0: merge nodes are disabled.") }}
          {% elif merge_node_min_chain_size == 1 %}
            {{ t("1: each shared procedure is a merge node.") }}
          {% else %}
            {{ t("{count}: only non-overlapping linear chains of {count}+ shared procedures are counted.", count=merge_node_min_chain_size) }}
          {% endif %}
        </div>
        <label class="team-graph-merge-threshold-input" for="merge_node_min_chain_size">
          <input
            id="merge_node_min_chain_size"
            type="range"
            min="0"
            max="10"
            step="1"
            value="{{ merge_node_min_chain_size }}"
            name="merge_node_min_chain_size"
            form="team-graph-form"
            data-merge-threshold-input
          />
        </label>
        <div class="team-graph-merge-threshold-scale" aria-hidden="true">
          <span>0</span>
          <span>5</span>
          <span>10</span>
        </div>
      </div>
      <div class="team-graph-flag-grid">
        <div
          class="team-graph-flag-item {% if merge_selected_markups %}is-on{% endif %}"
          data-flag-item
        >
          <div class="team-graph-flag-header">
            <span
              class="team-graph-flag-status"
              data-flag-status
              data-state="{% if merge_selected_markups %}on{% else %}off{% endif %}"
            >
              {% if merge_selected_markups %}{{ t("Enabled") }}{% else %}{{ t("Disabled") }}{% endif %}
            </span>
          </div>
          <div class="team-graph-flag-title">
            {{ t("Merge markups by shared nodes") }}
          </div>
          <div class="team-graph-flag-text">
            {{ t("How selected graphs render their components in according to shared nodes.") }}
          </div>
          <div class="team-graph-flag-action">
            <button
              class="primary-button team-graph-flag-button"
              type="button"
              data-flag-toggle="merge_selected_markups"
              data-state="{% if merge_selected_markups %}on{% else %}off{% endif %}"
              aria-pressed="{% if merge_selected_markups %}true{% else %}false{% endif %}"
            >
              {% if merge_selected_markups %}{{ t("Disable") }}{% else %}{{ t("Enable") }}{% endif %}
            </button>
          </div>
          <input
            type="hidden"
            id="merge_selected_markups"
            name="merge_selected_markups"
            value="true"
            form="team-graph-form"
            {% if not merge_selected_markups %}disabled{% endif %}
          />
        </div>
        <div
          class="team-graph-flag-item {% if merge_nodes_all_markups %}is-on{% endif %}"
          data-flag-item
        >
          <div class="team-graph-flag-header">
            <span
              class="team-graph-flag-status"
              data-flag-status
              data-state="{% if merge_nodes_all_markups %}on{% else %}off{% endif %}"
            >
              {% if merge_nodes_all_markups %}{{ t("Enabled") }}{% else %}{{ t("Disabled") }}{% endif %}
            </span>
          </div>
          <div class="team-graph-flag-title">
            {{ t("Render merge nodes from all available markups") }}
          </div>
          <div class="team-graph-flag-text">
            {{ t("Merge nodes are derived from the full catalog, while only selected teams render.") }}
          </div>
          <div class="team-graph-flag-action">
            <button
              class="primary-button team-graph-flag-button"
              type="button"
              data-flag-toggle="merge_nodes_all_markups"
              data-state="{% if merge_nodes_all_markups %}on{% else %}off{% endif %}"
              aria-pressed="{% if merge_nodes_all_markups %}true{% else %}false{% endif %}"
            >
              {% if merge_nodes_all_markups %}{{ t("Disable") }}{% else %}{{ t("Enable") }}{% endif %}
            </button>
          </div>
          <input
            type="hidden"
            id="merge_nodes_all_markups"
            name="merge_nodes_all_markups"
            value="true"
            form="team-graph-form"
            {% if not merge_nodes_all_markups %}disabled{% endif %}
          />
        </div>
      </div>
    </div>

    <div class="detail-card team-graph-result-card">
      <h3>{{ t("Step 3. Merge graphs") }}</h3>
      <div class="team-graph-cta">
          <div class="team-graph-cta-copy">
            <div class="team-graph-cta-title">{{ t("Merge selected teams") }}</div>
            <div class="team-graph-cta-text">
              {{ t("Once merged, status appears here; analytics opens in Step 4 and actions in Step 5.") }}
            </div>
          </div>
        <div class="team-graph-cta-action">
          <button
            class="primary-button team-graph-merge-button"
            type="submit"
            form="team-graph-form"
            data-merge-button
            {% if not team_ids %}disabled aria-disabled="true"{% endif %}
          >
            {{ t("Merge") }}
          </button>
        </div>
      </div>
      <div
        class="team-graph-cta-warning {% if team_ids %}is-hidden{% endif %}"
        data-team-required-message
        role="status"
        aria-live="polite"
      >
        {{ t("Select at least one team to enable Merge.") }}
      </div>
      <div class="team-graph-merge-loader" id="team-graph-merge-loader" aria-live="polite">
        <div class="team-graph-merge-loader-spinner" aria-hidden="true"></div>
        <div class="team-graph-merge-loader-copy">
          <div class="team-graph-merge-loader-title">{{ t("Merging selected graphs") }}</div>
          <div class="team-graph-merge-loader-text">
            Mapping shared nodes and building a cross-team dashboard...
          </div>
        </div>
      </div>
      <div class="team-graph-result">
        {% set team_dashboard_section = "" %}
        {% if diagram_ready %}
          <div class="team-graph-result-header">
            <span class="team-graph-result-status team-graph-result-ready">{{ t("Merge ready") }}</span>
            {% if selected_team_count %}
              <span class="team-graph-result-meta">
                {{ selected_team_count }} teams 路 {{ selected_markups_count }} markups merged
              </span>
            {% endif %}
          </div>
          <div class="team-graph-result-body">
            {{ t("Merge completed. Continue to Step 4 for analytics and Step 5 for diagram actions.") }}
          </div>
          {% if team_dashboard %}
            {% set total_procedures = team_dashboard.total_procedure_count %}
            {% set total_services = team_dashboard.total_service_count %}
            {% set team_dashboard_section %}
            <section class="team-graph-dashboard">
              <details
                class="team-graph-dashboard-section team-graph-dashboard-section-collapsible"
                data-dashboard-section-key="graphs-info"
              >
                <summary class="team-graph-dashboard-summary">
                  <span class="team-graph-dashboard-title">{{ t("Graphs info") }}</span>
                  <span class="team-graph-dashboard-summary-hint" data-dashboard-summary-hint>{{ t("Click to expand") }}</span>
                </summary>
                <div class="team-graph-dashboard-content">
                <div class="team-graph-dashboard-grid">
                  <article class="team-graph-kpi-card">
                    <div class="team-graph-kpi-head">
                      <div class="team-graph-kpi-label">{{ t("Graphs") }}</div>
                      <div class="team-graph-help team-graph-help-inline">
                        <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="Graphs help">?</button>
                        <div class="team-graph-help-popover team-graph-help-popover-wide">
                          <div class="team-graph-help-title">{{ t("Unique graphs") }}</div>
                          <div class="team-graph-help-hint">{{ t("Count of unique graphs from selected teams.") }}</div>
                        </div>
                      </div>
                    </div>
                    <div class="team-graph-kpi-value">{{ team_dashboard.unique_graph_count }}</div>
                    <div class="team-graph-kpi-note">{{ t("Detailed list is shown below.") }}</div>
                  </article>
                  <article class="team-graph-kpi-card team-graph-kpi-card-drilldown">
                    <div class="team-graph-kpi-head">
                      <div class="team-graph-kpi-label">{{ t("Bot graphs") }}</div>
                      <div class="team-graph-help team-graph-help-inline">
                        <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="Bot graphs help">?</button>
                        <div class="team-graph-help-popover team-graph-help-popover-wide">
                          <div class="team-graph-help-title">{{ t("Bot graphs") }}</div>
                          <div class="team-graph-help-hint">{{ t("Graphs where at least one procedure_id contains bot.") }}</div>
                        </div>
                      </div>
                    </div>
                    <div class="team-graph-kpi-value">{{ team_dashboard.bot_graph_count }}</div>
                    {% if team_dashboard.bot_graphs %}
                      <div class="team-graph-hover-list">
                        {% for item in team_dashboard.bot_graphs %}
                          <div class="team-graph-hover-item team-graph-hover-item-entities">
                            {{ render_graph_label_entities(item) }}
                          </div>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </article>
                  <article class="team-graph-kpi-card team-graph-kpi-card-drilldown">
                    <div class="team-graph-kpi-head">
                      <div class="team-graph-kpi-label">{{ t("Multi graphs") }}</div>
                      <div class="team-graph-help team-graph-help-inline">
                        <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="Multi graphs help">?</button>
                        <div class="team-graph-help-popover team-graph-help-popover-wide">
                          <div class="team-graph-help-title">{{ t("Multichannel graphs") }}</div>
                          <div class="team-graph-help-hint">{{ t("Graphs where at least one procedure_id contains multi.") }}</div>
                        </div>
                      </div>
                    </div>
                    <div class="team-graph-kpi-value">{{ team_dashboard.multi_graph_count }}</div>
                    {% if team_dashboard.multi_graphs %}
                      <div class="team-graph-hover-list">
                        {% for item in team_dashboard.multi_graphs %}
                          <div class="team-graph-hover-item team-graph-hover-item-entities">
                            {{ render_graph_label_entities(item) }}
                          </div>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </article>
                  <article class="team-graph-kpi-card">
                    <div class="team-graph-kpi-head">
                      <div class="team-graph-kpi-label">{{ t("Unique procedures") }}</div>
                      <div class="team-graph-help team-graph-help-inline">
                        <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="Unique procedures help">?</button>
                        <div class="team-graph-help-popover team-graph-help-popover-wide">
                          <div class="team-graph-help-title">{{ t("Unique procedures") }}</div>
                          <div class="team-graph-help-hint">{{ t("Unique procedure_id count across all selected markups.") }}</div>
                        </div>
                      </div>
                    </div>
                    <div class="team-graph-kpi-value">{{ team_dashboard.unique_procedure_count }}</div>
                  </article>
                </div>
                <article class="team-graph-data-card team-graph-graphs-details-card">
                  <div class="team-graph-data-head">
                    <div class="team-graph-data-title">{{ t("Graphs and intersections details") }}</div>
                    <div class="team-graph-help team-graph-help-inline">
                      <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="Graphs and intersections details help">?</button>
                      <div class="team-graph-help-popover team-graph-help-popover-wide">
                        <div class="team-graph-help-title">{{ t("Graphs and intersections details") }}</div>
                        <div class="team-graph-help-hint">{{ t("Grouped by markup or by unique merged-markup combination, ranked by graph count.") }}</div>
                      </div>
                    </div>
                  </div>
                  {% if team_dashboard.graph_groups %}
                    <div class="team-graph-graphs-list" data-sortable-table>
                      <div class="team-graph-graphs-row team-graph-graphs-row-header">
                        <span>{{ t("Graphs") }}</span>
                        <span>
                          <button
                            class="team-graph-sort-button"
                            type="button"
                            data-sort-trigger
                            data-sort-key="graph-count"
                            data-sort-type="number"
                            data-sort-default-order="desc"
                          >
                            Count
                          </button>
                        </span>
                        <span>
                          <button
                            class="team-graph-sort-button"
                            type="button"
                            data-sort-trigger
                            data-sort-key="merge-count"
                            data-sort-type="number"
                            data-sort-default-order="desc"
                          >
                            {% if merge_selected_markups %}Real merges{% else %}Potential merges{% endif %}
                          </button>
                        </span>
                      </div>
                      <div data-sort-items>
                      {% for item in team_dashboard.graph_groups %}
                        {% set entities = item.label.split(' + ') %}
                        {% set merge_count_ns = namespace(value=0) %}
                        {% for component in item.components %}
                          {% set merge_count_ns.value = merge_count_ns.value + (component.merge_nodes | length) %}
                        {% endfor %}
                        {% set item_merge_nodes_count = merge_count_ns.value %}
                        <details
                          class="team-graph-graphs-item {% if entities|length > 1 %}is-merged{% endif %}"
                          data-graph-group-size="{{ entities|length }}"
                          data-sort-item
                          data-sort-graph-count="{{ item.graph_count }}"
                          data-sort-merge-count="{{ item_merge_nodes_count }}"
                        >
                          <summary class="team-graph-graphs-row">
                            {{ render_graph_label_entities(item.label, force_colorize=true) }}
                            <span class="team-graph-graphs-count">
                              <span class="team-graph-graphs-count-value">{{ item.graph_count }}</span>
                              <span class="team-graph-graphs-count-label">graph{% if item.graph_count != 1 %}s{% endif %}</span>
                            </span>
                            <span class="team-graph-graphs-merge-count {% if not merge_selected_markups and item_merge_nodes_count %}team-graph-graphs-merge-count-warning{% endif %}">
                              <span class="team-graph-graphs-count-value">{{ item_merge_nodes_count }}</span>
                              <span class="team-graph-graphs-count-label">
                                {% if merge_selected_markups %}node{% else %}potential{% endif %}{% if item_merge_nodes_count != 1 %}s{% endif %}
                              </span>
                            </span>
                          </summary>
                          {% set merge_ns = namespace(has_merge_nodes=false) %}
                          {% for component in item.components %}
                            {% if component.merge_nodes %}
                              {% set merge_ns.has_merge_nodes = true %}
                            {% endif %}
                          {% endfor %}
                          {% if merge_ns.has_merge_nodes %}
                            <div class="team-graph-graphs-item-details">
                              <div class="team-graph-ranked-details-label">
                                {% if merge_selected_markups %}
                                  Intersection node breakdown
                                {% else %}
                                  Potential intersection node breakdown
                                {% endif %}
                              </div>
                              {% if not merge_selected_markups %}
                                <div class="team-graph-potential-note">
                                  {{ t("Potential merges only: markups are rendered separately because Merge markups by shared nodes is disabled.") }}
                                </div>
                              {% endif %}
                              {% for component in item.components %}
                                {% if component.merge_nodes %}
                                  <div class="team-graph-merge-component">
                                    <div class="team-graph-merge-component-title">
                                      {{ render_graph_label_entities(component.graph_label, force_colorize=true) }}
                                    </div>
                                    <div class="team-graph-merge-nodes-grid">
                                      {% for merge_node in component.merge_nodes %}
                                        <article class="team-graph-merge-node-card">
                                          <div class="team-graph-merge-node-id">
                                            {{ render_procedure_caption(merge_node.procedure_name, merge_node.procedure_id) }}
                                          </div>
                                          <div class="team-graph-merge-node-entities">
                                            {% for entity in merge_node.entities %}
                                              {{ render_team_service_entity(entity, "team-graph-graph-entity-sm", true) }}
                                            {% endfor %}
                                          </div>
                                        </article>
                                      {% endfor %}
                                    </div>
                                  </div>
                                {% endif %}
                              {% endfor %}
                            </div>
                          {% endif %}
                        </details>
                      {% endfor %}
                      </div>
                    </div>
                  {% else %}
                    <div class="team-graph-empty">{{ t("No graphs detected for selected markups.") }}</div>
                  {% endif %}
                </article>
                <div class="team-graph-split-grid">
                  <article class="team-graph-data-card">
                    <div class="team-graph-data-head">
                      <div class="team-graph-data-title">{{ t("Markup types") }}</div>
                      <div class="team-graph-help team-graph-help-inline">
                        <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="Markup types help">?</button>
                        <div class="team-graph-help-popover team-graph-help-popover-wide">
                          <div class="team-graph-help-title">{{ t("Markup types") }}</div>
                          <div class="team-graph-help-hint">{{ t("Total selected markups split by markup_type.") }}</div>
                        </div>
                      </div>
                    </div>
                    <div class="team-graph-chip-row">
                      {% for stat in team_dashboard.markup_type_counts %}
                        <span class="team-graph-chip team-graph-chip-drilldown">
                          {{ stat.markup_type | humanize_text }} 路 {{ stat.count }}
                          {% if stat.item_labels %}
                            <span class="team-graph-chip-list">
                              {% for item in stat.item_labels %}
                                <span class="team-graph-chip-list-item">
                                  {{ render_team_service_entity(item, "team-graph-graph-entity-sm") }}
                                </span>
                              {% endfor %}
                            </span>
                          {% endif %}
                        </span>
                      {% endfor %}
                    </div>
                  </article>
                  <article class="team-graph-data-card">
                    <div class="team-graph-data-head">
                      <div class="team-graph-data-title">{{ t("Procedure mix") }}</div>
                      <div class="team-graph-help team-graph-help-inline">
                        <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="Procedure mix help">?</button>
                        <div class="team-graph-help-popover team-graph-help-popover-wide">
                          <div class="team-graph-help-title">{{ t("Procedure mix") }}</div>
                          <div class="team-graph-help-hint">{{ t("Share among all procedures in selected markups by procedure_id substring: bot, multi, and everything else is employee procedures.") }}</div>
                        </div>
                      </div>
                    </div>
                    <div class="team-graph-inline-metric team-graph-inline-metric-drilldown">
                      <span class="team-graph-inline-metric-label">{{ t("Bot procedures") }}</span>
                      <span class="team-graph-inline-metric-value">
                        {% if total_procedures %}
                          {{ (team_dashboard.bot_procedure_count * 100 / total_procedures) | round(1) }}%
                        {% else %}
                          0%
                        {% endif %}
                      </span>
                      <span class="team-graph-inline-metric-note">{{ team_dashboard.bot_procedure_count }} / {{ total_procedures }}</span>
                      {% if team_dashboard.bot_procedures %}
                        <div class="team-graph-hover-list team-graph-hover-list-inline">
                          {% for item in team_dashboard.bot_procedures %}
                            <div class="team-graph-hover-item team-graph-mono">{{ item }}</div>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                    <div class="team-graph-inline-metric team-graph-inline-metric-drilldown">
                      <span class="team-graph-inline-metric-label">{{ t("Multichannel procedures") }}</span>
                      <span class="team-graph-inline-metric-value">
                        {% if total_procedures %}
                          {{ (team_dashboard.multi_procedure_count * 100 / total_procedures) | round(1) }}%
                        {% else %}
                          0%
                        {% endif %}
                      </span>
                      <span class="team-graph-inline-metric-note">{{ team_dashboard.multi_procedure_count }} / {{ total_procedures }}</span>
                      {% if team_dashboard.multi_procedures %}
                        <div class="team-graph-hover-list team-graph-hover-list-inline">
                          {% for item in team_dashboard.multi_procedures %}
                            <div class="team-graph-hover-item team-graph-mono">{{ item }}</div>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                    <div class="team-graph-inline-metric team-graph-inline-metric-drilldown">
                      <span class="team-graph-inline-metric-label">{{ t("Employee procedures") }}</span>
                      <span class="team-graph-inline-metric-value">
                        {% if total_procedures %}
                          {{ (team_dashboard.employee_procedure_count * 100 / total_procedures) | round(1) }}%
                        {% else %}
                          0%
                        {% endif %}
                      </span>
                      <span class="team-graph-inline-metric-note">{{ team_dashboard.employee_procedure_count }} / {{ total_procedures }}</span>
                      {% if team_dashboard.employee_procedures %}
                        <div class="team-graph-hover-list team-graph-hover-list-inline">
                          {% for item in team_dashboard.employee_procedures %}
                            <div class="team-graph-hover-item team-graph-mono">{{ item }}</div>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                  </article>
                </div>
                </div>
              </details>

              <details
                class="team-graph-dashboard-section team-graph-dashboard-section-collapsible"
                data-dashboard-section-key="markup-self-sufficiency"
              >
                <summary class="team-graph-dashboard-summary">
                  <span class="team-graph-dashboard-title">{{ t("Markup self-sufficiency") }}</span>
                  <span class="team-graph-dashboard-summary-hint" data-dashboard-summary-hint>{{ t("Click to expand") }}</span>
                </summary>
                <div class="team-graph-dashboard-content">
                <div class="team-graph-dashboard-grid">
                  <article class="team-graph-kpi-card team-graph-kpi-card-drilldown">
                    <div class="team-graph-kpi-head">
                      <div class="team-graph-kpi-label">{{ t("Internal overlap markups") }}</div>
                      <div class="team-graph-help team-graph-help-inline">
                        <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="Internal overlap help">?</button>
                        <div class="team-graph-help-popover team-graph-help-popover-wide">
                          <div class="team-graph-help-title">{{ t("Internal overlap markups") }}</div>
                          <div class="team-graph-help-hint">{{ t("Markups that share at least one procedure with another selected markup.") }}</div>
                        </div>
                      </div>
                    </div>
                    <div class="team-graph-kpi-value">
                      {{ team_dashboard.internal_intersection_markup_count }}
                    </div>
                    {% if team_dashboard.internal_intersection_entities %}
                      <div class="team-graph-hover-list">
                        {% for item in team_dashboard.internal_intersection_entities %}
                          <div class="team-graph-hover-item">
                            {{ render_team_service_entity(item, "team-graph-graph-entity-sm", true) }}
                          </div>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </article>
                  <article class="team-graph-kpi-card team-graph-kpi-card-drilldown">
                    <div class="team-graph-kpi-head">
                      <div class="team-graph-kpi-label">{{ t("External overlap markups") }}</div>
                      <div class="team-graph-help team-graph-help-inline">
                        <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="External overlap help">?</button>
                        <div class="team-graph-help-popover team-graph-help-popover-wide">
                          <div class="team-graph-help-title">{{ t("External overlap markups") }}</div>
                          <div class="team-graph-help-hint">{{ t("Markups that intersect with at least one markup from teams outside selection.") }}</div>
                        </div>
                      </div>
                    </div>
                    <div class="team-graph-kpi-value">
                      {{ team_dashboard.external_intersection_markup_count }}
                    </div>
                    {% if team_dashboard.external_intersection_entities %}
                      <div class="team-graph-hover-list">
                        {% for item in team_dashboard.external_intersection_entities %}
                          <div class="team-graph-hover-item">
                            {{ render_team_service_entity(item, "team-graph-graph-entity-sm") }}
                          </div>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </article>
                  <article class="team-graph-kpi-card team-graph-kpi-card-drilldown">
                    <div class="team-graph-kpi-head">
                      <div class="team-graph-kpi-label">{{ t("Split markups") }}</div>
                      <div class="team-graph-help team-graph-help-inline">
                        <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="Split markups help">?</button>
                        <div class="team-graph-help-popover team-graph-help-popover-wide">
                          <div class="team-graph-help-title">{{ t("Split markups") }}</div>
                          <div class="team-graph-help-hint">{{ t("Markups with more than one disconnected component in their procedure graph.") }}</div>
                        </div>
                      </div>
                    </div>
                    <div class="team-graph-kpi-value">{{ team_dashboard.split_service_count }}</div>
                    {% if team_dashboard.split_entities %}
                      <div class="team-graph-hover-list">
                        {% for item in team_dashboard.split_entities %}
                          <div class="team-graph-hover-item">
                            {{ render_team_service_entity(item, "team-graph-graph-entity-sm") }}
                          </div>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </article>
                  <article class="team-graph-kpi-card team-graph-kpi-card-drilldown">
                    <div class="team-graph-kpi-head">
                      <div class="team-graph-kpi-label">{{ t("Target markups") }}</div>
                      <div class="team-graph-help team-graph-help-inline">
                        <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="Target markups help">?</button>
                        <div class="team-graph-help-popover team-graph-help-popover-wide">
                          <div class="team-graph-help-title">{{ t("Target markups") }}</div>
                          <div class="team-graph-help-hint">{{ t("Markups without overlaps with other markups and without disconnected parts.") }}</div>
                        </div>
                      </div>
                    </div>
                    <div class="team-graph-kpi-value">
                      {% if total_services %}
                        {{ (team_dashboard.target_service_count * 100 / total_services) | round(1) }}%
                      {% else %}
                        0%
                      {% endif %}
                    </div>
                    <div class="team-graph-kpi-note">{{ team_dashboard.target_service_count }} / {{ total_services }}</div>
                    {% if team_dashboard.target_entities %}
                      <div class="team-graph-hover-list">
                        {% for item in team_dashboard.target_entities %}
                          <div class="team-graph-hover-item">
                            {{ render_team_service_entity(item, "team-graph-graph-entity-sm") }}
                          </div>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </article>
                </div>
                <article class="team-graph-data-card">
                  <div class="team-graph-data-head">
                    <div class="team-graph-data-title">{{ t("External team overlaps") }}</div>
                    <div class="team-graph-help team-graph-help-inline">
                      <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="External team overlaps help">?</button>
                      <div class="team-graph-help-popover team-graph-help-popover-wide">
                        <div class="team-graph-help-title">{{ t("External team overlaps") }}</div>
                        <div class="team-graph-help-hint">{{ t("Teams outside selection are ranked by total merge intersections with a split by dependency direction: external team depends on selected teams, and selected teams depend on external team. Click a team row to view service-level details.") }}</div>
                      </div>
                    </div>
                  </div>
                  {% if team_dashboard.external_team_intersections %}
                    {% set hidden_external_team_count = (team_dashboard.external_team_intersections|length) - 10 %}
                    <div
                      class="team-graph-ranked-list team-graph-overlap-list"
                      data-sortable-table
                      data-overlap-sortable
                      data-overlap-limit="10"
                    >
                      <div class="team-graph-overlap-row team-graph-overlap-row-header">
                        <span>{{ t("Team") }}</span>
                        <span>
                          <button
                            class="team-graph-sort-button"
                            type="button"
                            data-sort-trigger
                            data-sort-key="external-count"
                            data-sort-type="number"
                            data-sort-default-order="desc"
                          >
                            External &rarr; selected
                          </button>
                        </span>
                        <span>
                          <button
                            class="team-graph-sort-button"
                            type="button"
                            data-sort-trigger
                            data-sort-key="selected-count"
                            data-sort-type="number"
                            data-sort-default-order="desc"
                          >
                            Selected &rarr; external
                          </button>
                        </span>
                        <span>
                          <button
                            class="team-graph-sort-button"
                            type="button"
                            data-sort-trigger
                            data-sort-key="total-count"
                            data-sort-type="number"
                            data-sort-default-order="desc"
                          >
                            Total
                          </button>
                        </span>
                        <span>
                          <button
                            class="team-graph-sort-button"
                            type="button"
                            data-sort-trigger
                            data-sort-key="overlap-percent"
                            data-sort-type="number"
                            data-sort-default-order="desc"
                          >
                            Overlap %
                          </button>
                        </span>
                      </div>
                      <div class="team-graph-overlap-teams" data-sort-items data-overlap-team-list>
                      {% for item in team_dashboard.external_team_intersections %}
                        <div
                          class="team-graph-overlap-team"
                          data-overlap-team-card
                          data-sort-item
                          data-sort-external-count="{{ item.external_depends_on_selected_count }}"
                          data-sort-selected-count="{{ item.selected_depends_on_external_count }}"
                          data-sort-total-count="{{ item.count }}"
                          data-sort-overlap-percent="{{ item.overlap_procedure_percent }}"
                        >
                          <button
                            class="team-graph-overlap-row team-graph-overlap-toggle-row"
                            type="button"
                            data-overlap-team-toggle
                            aria-expanded="false"
                          >
                            <span class="team-graph-overlap-main-label">
                              <span data-overlap-rank data-sort-rank data-sort-rank-suffix=".">{{ loop.index }}.</span>
                              {{ item.team_name }}
                            </span>
                            <span class="team-graph-overlap-value">{{ item.external_depends_on_selected_count }}</span>
                            <span class="team-graph-overlap-value">{{ item.selected_depends_on_external_count }}</span>
                            <span class="team-graph-overlap-value">{{ item.count }}</span>
                            <span class="team-graph-overlap-value">{{ item.overlap_procedure_percent | round(1) }}%</span>
                          </button>
                          {% if item.services %}
                            <div class="team-graph-overlap-entities" data-overlap-team-details>
                              {% for service in item.services %}
                                <div class="team-graph-overlap-row team-graph-overlap-row-service">
                                  <span class="team-graph-overlap-service">
                                    {{ render_team_service_entity(item.team_name ~ ' / ' ~ service.markup_type ~ ' / ' ~ service.service_name, "team-graph-graph-entity-sm", true) }}
                                  </span>
                                  <span class="team-graph-overlap-count">{{ service.external_depends_on_selected_count }}</span>
                                  <span class="team-graph-overlap-count">{{ service.selected_depends_on_external_count }}</span>
                                  <span class="team-graph-overlap-count">{{ service.count }}</span>
                                  <span class="team-graph-overlap-count">{{ service.overlap_procedure_percent | round(1) }}%</span>
                                </div>
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      {% endfor %}
                      </div>
                      {% if hidden_external_team_count > 0 %}
                        <button class="team-graph-overlap-more-button" type="button" data-overlap-more-toggle aria-expanded="false">
                          {{ t("Show {count} more teams", count=hidden_external_team_count) }}
                        </button>
                      {% endif %}
                    </div>
                  {% else %}
                    <div class="team-graph-empty">{{ t("No intersections with teams outside the selection.") }}</div>
                  {% endif %}
                </article>
                </div>
              </details>

              <details
                class="team-graph-dashboard-section team-graph-dashboard-section-collapsible"
                data-dashboard-section-key="risk-hotspots"
              >
                <summary class="team-graph-dashboard-summary">
                  <span class="team-graph-dashboard-title">{{ t("Risk hotspots") }}</span>
                  <span class="team-graph-dashboard-summary-hint" data-dashboard-summary-hint>{{ t("Click to expand") }}</span>
                </summary>
                <div class="team-graph-dashboard-content">
                <article class="team-graph-data-card">
                  <div class="team-graph-data-head">
                    <div class="team-graph-data-title">{{ t("Top linking procedures") }}</div>
                    <div class="team-graph-help team-graph-help-inline">
                      <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="Top linking procedures help">?</button>
                      <div class="team-graph-help-popover team-graph-help-popover-wide">
                        <div class="team-graph-help-title">{{ t("Top linking procedures") }}</div>
                        <div class="team-graph-help-hint">{{ t("Rank by cross-entity reuse and dependency fan-in/fan-out in merged procedure_graph data. Click a row to inspect per-graph dependency impact for the same procedure.") }}</div>
                      </div>
                    </div>
                  </div>
                  <div class="team-graph-data-context">{{ t("Ranking priority: cross-entity reuse -> total dependencies (incoming + outgoing) -> incoming -> outgoing. Based only on selected markups, deterministic for the same input.") }}</div>
                  {% if team_dashboard.linking_procedures %}
                    <div class="team-graph-ranked-table" data-sortable-table>
                      <div class="team-graph-ranked-table-row team-graph-ranked-table-header">
                        <span>{{ t("Procedure") }}</span>
                        <span>
                          <button
                            class="team-graph-sort-button"
                            type="button"
                            data-sort-trigger
                            data-sort-key="graph-count"
                            data-sort-type="number"
                            data-sort-default-order="desc"
                          >
                            Entities
                          </button>
                        </span>
                        <span>
                          <button
                            class="team-graph-sort-button"
                            type="button"
                            data-sort-trigger
                            data-sort-key="cross-entity"
                            data-sort-type="number"
                            data-sort-default-order="desc"
                          >
                            Cross-entity
                          </button>
                        </span>
                        <span>
                          <button
                            class="team-graph-sort-button"
                            type="button"
                            data-sort-trigger
                            data-sort-key="incoming"
                            data-sort-type="number"
                            data-sort-default-order="desc"
                          >
                            Inbound deps
                          </button>
                        </span>
                        <span>
                          <button
                            class="team-graph-sort-button"
                            type="button"
                            data-sort-trigger
                            data-sort-key="outgoing"
                            data-sort-type="number"
                            data-sort-default-order="desc"
                          >
                            Outbound deps
                          </button>
                        </span>
                      </div>
                      <div data-sort-items>
                      {% for item in team_dashboard.linking_procedures %}
                        <details
                          class="team-graph-ranked-table-item"
                          data-sort-item
                          data-sort-graph-count="{{ item.graph_count }}"
                          data-sort-cross-entity="{{ item.usage_in_other_graphs }}"
                          data-sort-incoming="{{ item.incoming_edges }}"
                          data-sort-outgoing="{{ item.outgoing_edges }}"
                        >
                          <summary class="team-graph-ranked-table-row">
                            <span>
                              <span class="team-graph-procedure-order" data-sort-rank>{{ loop.index }}</span>
                              {{ render_procedure_caption(item.procedure_name, item.procedure_id) }}
                            </span>
                            <span>{{ item.graph_count }}</span>
                            <span>{{ item.usage_in_other_graphs }}</span>
                            <span>{{ item.incoming_edges }}</span>
                            <span>{{ item.outgoing_edges }}</span>
                          </summary>
                          <div class="team-graph-ranked-table-details">
                            <div class="team-graph-ranked-details-label">{{ t("Graph-level breakdown") }}</div>
                            <div class="team-graph-ranked-table">
                              {% for graph_item in item.graph_usage_stats %}
                                <div class="team-graph-ranked-table-row">
                                  <span class="team-graph-ranked-details-list-entity team-graph-ranked-subitem-graph">
                                    {{ render_graph_label_entities(graph_item.graph_label, force_colorize=true) }}
                                  </span>
                                  <span>{{ "yes" if graph_item.is_cross_entity else "no" }}</span>
                                  <span>{{ graph_item.incoming_edges }}</span>
                                  <span>{{ graph_item.outgoing_edges }}</span>
                                </div>
                              {% endfor %}
                            </div>
                          </div>
                        </details>
                      {% endfor %}
                      </div>
                    </div>
                  {% else %}
                    <div class="team-graph-empty">{{ t("No procedure-level data.") }}</div>
                  {% endif %}
                </article>
                <article class="team-graph-data-card team-graph-data-card-spaced">
                  <div class="team-graph-data-head">
                    <div class="team-graph-data-title">{{ t("Top overloaded entities") }}</div>
                    <div class="team-graph-help team-graph-help-inline">
                      <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="Top overloaded entities help">?</button>
                      <div class="team-graph-help-popover team-graph-help-popover-wide">
                        <div class="team-graph-help-title">{{ t("Top overloaded entities") }}</div>
                        <div class="team-graph-help-hint">
                          {{ t("Rank by structural risk in merged procedure_graph: shared-node merges with other entities, cycles, procedure volume, then block volume.") }}
                          {{ t("Click a row for per-procedure breakdown.") }}
                          {{ t("In breakdown, Links is the sum of incoming and outgoing unique procedure links for each procedure.") }}
                          {% if not merge_selected_markups %}
                            {{ t("With Merge markups by shared nodes disabled, merge metrics are shown as potential merges.") }}
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="team-graph-data-context">{{ t("Ranking priority: merges -> cycles -> procedures -> blocks. These metrics are computed directly from graph structure and block lists.") }}</div>
                  {% if team_dashboard.overloaded_services %}
                    <div class="team-graph-ranked-table team-graph-ranked-table-services" data-sortable-table>
                      <div class="team-graph-ranked-table-row team-graph-ranked-table-header">
                        <span>{{ t("Entity") }}</span>
                        <span>
                          <button
                            class="team-graph-sort-button"
                            type="button"
                            data-sort-trigger
                            data-sort-key="procedure-count"
                            data-sort-type="number"
                            data-sort-default-order="desc"
                          >
                            Procedures
                          </button>
                        </span>
                        <span>
                          <button
                            class="team-graph-sort-button"
                            type="button"
                            data-sort-trigger
                            data-sort-key="merge-count"
                            data-sort-type="number"
                            data-sort-default-order="desc"
                          >
                            Merges
                          </button>
                        </span>
                        <span>
                          <button
                            class="team-graph-sort-button"
                            type="button"
                            data-sort-trigger
                            data-sort-key="cycle-count"
                            data-sort-type="number"
                            data-sort-default-order="desc"
                          >
                            Cycles
                          </button>
                        </span>
                        <span>
                          <button
                            class="team-graph-sort-button"
                            type="button"
                            data-sort-trigger
                            data-sort-key="block-count"
                            data-sort-type="number"
                            data-sort-default-order="desc"
                          >
                            Blocks
                          </button>
                        </span>
                      </div>
                      <div data-sort-items>
                      {% for item in team_dashboard.overloaded_services %}
                        <details
                          class="team-graph-ranked-table-item"
                          data-sort-item
                          data-sort-procedure-count="{{ item.procedure_count }}"
                          data-sort-merge-count="{{ item.in_team_merge_nodes }}"
                          data-sort-cycle-count="{{ item.cycle_count }}"
                          data-sort-block-count="{{ item.block_count }}"
                        >
                          <summary class="team-graph-ranked-table-row">
                            <span>
                              <span class="team-graph-procedure-order" data-sort-rank>{{ loop.index }}</span>
                              {{ render_team_service_entity(item.team_name ~ ' / ' ~ item.markup_type ~ ' / ' ~ item.service_name, "team-graph-graph-entity-sm", true) }}
                            </span>
                            <span>{{ item.procedure_count }}</span>
                            <span>{{ item.in_team_merge_nodes }}</span>
                            <span>{{ item.cycle_count }}</span>
                            <span>{{ item.block_count }}</span>
                          </summary>
                          <div class="team-graph-ranked-table-details">
                            <div class="team-graph-ranked-details-label">
                              {% if merge_selected_markups %}
                                Procedure-level breakdown (graph order)
                              {% else %}
                                Procedure-level breakdown (graph order, potential merges)
                              {% endif %}
                            </div>
                            {% if not merge_selected_markups %}
                              <div class="team-graph-potential-note">
                                Potential merges only: graph rendering keeps procedures separated while
                                still surfacing shared-node overlap risk.
                              </div>
                            {% endif %}
                            <div class="team-graph-ranked-table">
                              <div class="team-graph-ranked-table-row team-graph-ranked-table-header">
                                <span>{{ t("Procedure") }}</span>
                                <span>
                                  {% if merge_selected_markups %}Merges{% else %}Potential merges{% endif %}
                                </span>
                                <span>
                                  Cycle
                                </span>
                                <span>
                                  Links
                                </span>
                                <span>
                                  Blocks
                                </span>
                              </div>
                              <div>
                              {% set graph_group = namespace(current=None) %}
                              {% for proc_item in item.procedure_usage_stats %}
                                {% if proc_item.graph_label and proc_item.graph_label != graph_group.current %}
                                  <div class="team-graph-ranked-table-row team-graph-ranked-table-header team-graph-procedure-group-header">
                                    <span><span class="team-graph-procedure-group-badge">{{ proc_item.graph_label }}</span></span>
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                  </div>
                                  {% set graph_group.current = proc_item.graph_label %}
                                {% endif %}
                                <div
                                  class="team-graph-ranked-table-row{% if proc_item.graph_label %} team-graph-procedure-group-row{% endif %}"
                                >
                                  <span class="team-graph-procedure-row-main">
                                    <span class="team-graph-procedure-order">
                                      P{{ proc_item.flow_order_in_graph or loop.index }}
                                      {% if proc_item.flow_level %}
                                        路 L{{ proc_item.flow_level }}
                                      {% endif %}
                                    </span>
                                    {{ render_procedure_caption(proc_item.procedure_name, proc_item.procedure_id) }}
                                    {% if proc_item.block_type_stats %}
                                      <span class="team-graph-procedure-block-meta">
                                        <span class="team-graph-procedure-block-types">
                                          {% for block_stat in proc_item.block_type_stats %}
                                            {% set block_label = block_stat.label %}
                                            {% if block_label == "End (exit)" %}
                                              {% set block_label = "Exit" %}
                                            {% elif block_label == "End (all)" %}
                                              {% set block_label = "End & Exit" %}
                                            {% elif block_label == "End (intermediate)" %}
                                              {% set block_label = "Intermediate" %}
                                            {% elif block_label == "End (postpone)" %}
                                              {% set block_label = "Postpone" %}
                                            {% elif block_label == "End (turn_out)" %}
                                              {% set block_label = "Turn out" %}
                                            {% endif %}
                                            <span
                                              class="team-graph-procedure-block-type"
                                              style="--team-graph-block-type-color: {{ block_stat.color }}"
                                            >
                                              {{ block_label }} 路 {{ block_stat.count }}
                                            </span>
                                          {% endfor %}
                                        </span>
                                      </span>
                                    {% endif %}
                                  </span>
                                  <span>{% if proc_item.in_team_merge_hits %}{{ proc_item.in_team_merge_hits }}{% endif %}</span>
                                  <span>{% if proc_item.cycle_hits %}{{ proc_item.cycle_hits }}{% endif %}</span>
                                  <span>{% if proc_item.linked_procedure_count %}{{ proc_item.linked_procedure_count }}{% endif %}</span>
                                  <span>{% if proc_item.block_count %}{{ proc_item.block_count }}{% endif %}</span>
                                </div>
                              {% endfor %}
                              </div>
                            </div>
                          </div>
                        </details>
                      {% endfor %}
                      </div>
                    </div>
                  {% else %}
                    <div class="team-graph-empty">{{ t("No service-level data.") }}</div>
                  {% endif %}
                </article>
                </div>
              </details>
            </section>
            {% endset %}
          {% endif %}
        {% elif error_message %}
          <div class="team-graph-result-header">
            <span class="team-graph-result-status team-graph-result-error">{{ t("Merge blocked") }}</span>
          </div>
          <div class="team-graph-result-body">{{ error_message }}</div>
        {% else %}
          <div class="team-graph-result-header">
            <span class="team-graph-result-status team-graph-result-idle">{{ t("Waiting for input") }}</span>
          </div>
          <div class="team-graph-result-body">
            {{ t("Select teams and click Merge. Status, analytics, and diagram actions appear in Steps 3-5.") }}
          </div>
        {% endif %}
      </div>
    </div>

    <div class="detail-card team-graph-analysis-card">
      <h3>{{ t("Step 4. Analyze graphs") }}</h3>
      {% if diagram_ready and team_dashboard %}
        <div class="team-graph-analysis-host" data-team-graph-analysis-host>
          {{ team_dashboard_section | safe }}
        </div>
      {% elif diagram_ready %}
        <p class="team-graph-subtitle">{{ t("Analytics is unavailable for the selected graph set.") }}</p>
      {% elif error_message %}
        <p class="team-graph-subtitle">{{ t("Resolve merge issues in Step 3 to unlock analytics.") }}</p>
      {% else %}
        <p class="team-graph-subtitle">{{ t("Merge graphs in Step 3 to open analytics.") }}</p>
      {% endif %}
    </div>

    <div class="detail-card team-graph-actions-card">
      <h3>{{ t("Step 5. Get diagram") }}</h3>
      {% if diagram_ready %}
        <div class="team-graph-actions-split">
          <article class="team-graph-actions-group" data-graph-level="procedure">
            <div class="team-graph-actions-group-title">{{ t("Procedure-level diagram") }}</div>
            <p class="team-graph-actions-group-subtitle">
              {{ t("Detailed flow between procedures with analytics context from Step 4.") }}
            </p>
            <div class="button-row">
              {% if diagram_excalidraw_enabled %}
                <a class="primary-button" target="_blank" href="{{ procedure_excalidraw_open_url }}">
                  {{ t("Open Excalidraw") }}
                </a>
              {% endif %}
              <a class="ghost-button" href="/api/teams/graph?{{ procedure_team_query }}&format=excalidraw&download=true">
                {{ t("Download .excalidraw") }}
              </a>
              <a class="ghost-button unidraw-button" href="/api/teams/graph?{{ procedure_team_query }}&format=unidraw&download=true">
                {{ t("Download .unidraw") }}
              </a>
            </div>
          </article>
          <article class="team-graph-actions-group" data-graph-level="service">
            <div class="team-graph-actions-group-title">{{ t("Service-level diagram") }}</div>
            <p class="team-graph-actions-group-subtitle">
              {{ t("High-level service map: service nodes aggregate all selected service graphs.") }}
            </p>
            <div class="button-row">
              {% if diagram_excalidraw_enabled %}
                <a class="primary-button" target="_blank" href="{{ service_excalidraw_open_url }}">
                  {{ t("Open Excalidraw") }}
                </a>
              {% endif %}
              <a class="ghost-button" href="/api/teams/graph?{{ service_team_query }}&format=excalidraw&download=true">
                {{ t("Download .excalidraw") }}
              </a>
              <a class="ghost-button unidraw-button" href="/api/teams/graph?{{ service_team_query }}&format=unidraw&download=true">
                {{ t("Download .unidraw") }}
              </a>
            </div>
          </article>
        </div>
      {% else %}
        <p class="team-graph-subtitle">{{ t("Merge graphs in Step 3 to enable diagram actions.") }}</p>
      {% endif %}
    </div>
  </section>

  <script>
    (() => {
      const I18N = {
        enable: {{ t("Enable") | tojson }},
        disable: {{ t("Disable") | tojson }},
        enabled: {{ t("Enabled") | tojson }},
        disabled: {{ t("Disabled") | tojson }},
        hideDisabledTeams: {{ t("Hide disabled teams") | tojson }},
        disableTeams: {{ t("Disable teams") | tojson }},
        mergeNodesDisabled: {{ t("0: merge nodes are disabled.") | tojson }},
        mergeNodePerProcedure: {{ t("1: each shared procedure is a merge node.") | tojson }},
        mergeNodeLinearTemplate: {{ t("{count}: only non-overlapping linear chains of {count}+ shared procedures are counted.", count="__COUNT__") | tojson }},
        node: {{ t("node") | tojson }},
        nodes: {{ t("nodes") | tojson }},
        showFewerTeams: {{ t("Show fewer teams") | tojson }},
        showMoreTeamsTemplate: {{ t("Show {count} more teams", count="__COUNT__") | tojson }},
        clickToCollapse: {{ t("Click to collapse") | tojson }},
        clickToExpand: {{ t("Click to expand") | tojson }},
      };

      const updateToggle = (button, input) => {
        const enabled = input.disabled === false;
        button.dataset.state = enabled ? "on" : "off";
        button.setAttribute("aria-pressed", enabled ? "true" : "false");
        button.textContent = enabled ? I18N.disable : I18N.enable;
        const card = button.closest("[data-flag-item]");
        if (card) {
          card.classList.toggle("is-on", enabled);
          const status = card.querySelector("[data-flag-status]");
          if (status) {
            status.textContent = enabled ? I18N.enabled : I18N.disabled;
            status.dataset.state = enabled ? "on" : "off";
          }
        }
      };

        const initTeamGraphPage = () => {
        const page = document.getElementById("team-graph-page");
        if (!(page instanceof HTMLElement) || page.dataset.initialized === "true") {
          return;
        }

        const form = page.querySelector("#team-graph-form");
        const select = page.querySelector("#team-graph-select");
        const input = page.querySelector("#team-graph-input");
        const excludeSelect = page.querySelector("#team-graph-exclude-select");
        const excludeInput = page.querySelector("#team-graph-exclude-input");
        if (
          !(form instanceof HTMLFormElement) ||
          !(select instanceof HTMLSelectElement) ||
          !(input instanceof HTMLInputElement) ||
          !(excludeSelect instanceof HTMLSelectElement) ||
          !(excludeInput instanceof HTMLInputElement)
        ) {
          return;
        }

        const mergeButton = page.querySelector("[data-merge-button]");
        const teamRequiredMessage = page.querySelector("[data-team-required-message]");
        const excludeToggle = page.querySelector("[data-exclude-toggle]");
        const excludePanel = page.querySelector("[data-exclude-panel]");
        const excludeGrid = page.querySelector("[data-exclude-grid]");
        const excludeBody = excludePanel?.querySelector(".team-graph-select-body");

        const updateMergeAvailability = (selectedCount) => {
          const hasSelection = selectedCount > 0;
          if (mergeButton instanceof HTMLButtonElement) {
            mergeButton.disabled = !hasSelection;
            mergeButton.setAttribute("aria-disabled", hasSelection ? "false" : "true");
          }
          if (teamRequiredMessage instanceof HTMLElement) {
            teamRequiredMessage.classList.toggle("is-hidden", hasSelection);
          }
        };

        const updateSummary = (key, value) => {
          const target = page.querySelector(`[data-summary-value="${key}"]`);
          if (target instanceof HTMLElement) {
            target.textContent = String(value);
          }
        };

        const sumMarkups = (options) =>
          options.reduce((total, option) => {
            const raw = option.getAttribute("data-markups") || "0";
            const parsed = Number(raw);
            return total + (Number.isFinite(parsed) ? parsed : 0);
          }, 0);

        const sync = () => {
          const values = Array.from(select.selectedOptions).map((option) => option.value);
          input.value = values.join(",");
          const excludedOptions = Array.from(excludeSelect.selectedOptions);
          const excluded = excludedOptions.map((option) => option.value);
          excludeInput.value = excluded.join(",");
          updateMergeAvailability(values.length);
          updateSummary("included-teams", values.length);
          updateSummary("included-markups", sumMarkups(Array.from(select.selectedOptions)));
          updateSummary("disabled-teams", excluded.length);
          updateSummary("disabled-markups", sumMarkups(excludedOptions));
        };

        const setExcludeOpen = (isOpen) => {
          if (excludeToggle instanceof HTMLButtonElement) {
            excludeToggle.setAttribute("aria-expanded", isOpen ? "true" : "false");
            excludeToggle.textContent = isOpen ? I18N.hideDisabledTeams : I18N.disableTeams;
          }
          if (excludePanel instanceof HTMLElement) {
            excludePanel.classList.toggle("is-collapsed", !isOpen);
          }
          if (excludeGrid instanceof HTMLElement) {
            excludeGrid.classList.toggle("is-collapsed", !isOpen);
          }
          if (excludeBody instanceof HTMLElement) {
            excludeBody.classList.toggle("is-hidden", !isOpen);
          }
        };

        const initialOpen = excludeToggle?.getAttribute("aria-expanded") === "true";
        setExcludeOpen(initialOpen);
        select.addEventListener("change", sync);
        excludeSelect.addEventListener("change", sync);
        excludeSelect.addEventListener("dblclick", (event) => {
          const option = event.target;
          if (option instanceof HTMLOptionElement) {
            option.selected = !option.selected;
            sync();
          }
        });
        if (excludeToggle instanceof HTMLButtonElement) {
          excludeToggle.addEventListener("click", () => {
            const isOpen = excludeToggle.getAttribute("aria-expanded") === "true";
            setExcludeOpen(!isOpen);
          });
        }
        form.addEventListener("submit", sync);
        sync();

        const mergeThresholdInput = page.querySelector("[data-merge-threshold-input]");
        const mergeThresholdValue = page.querySelector("[data-merge-threshold-value]");
        const mergeThresholdValueUnit = page.querySelector("[data-merge-threshold-value-unit]");
        const mergeThresholdText = page.querySelector("[data-merge-threshold-text]");
        const clampMergeThreshold = (value) => {
          const parsed = Number(value);
          if (!Number.isFinite(parsed)) {
            return 1;
          }
          return Math.min(10, Math.max(0, Math.round(parsed)));
        };
        const mergeThresholdDescription = (value) => {
          if (value === 0) {
            return I18N.mergeNodesDisabled;
          }
          if (value === 1) {
            return I18N.mergeNodePerProcedure;
          }
          return I18N.mergeNodeLinearTemplate.replaceAll("__COUNT__", String(value));
        };
        const syncMergeThreshold = () => {
          if (!(mergeThresholdInput instanceof HTMLInputElement)) {
            return;
          }
          const value = clampMergeThreshold(mergeThresholdInput.value);
          mergeThresholdInput.value = String(value);
          if (mergeThresholdValue instanceof HTMLElement) {
            mergeThresholdValue.textContent = String(value);
          }
          if (mergeThresholdValueUnit instanceof HTMLElement) {
            mergeThresholdValueUnit.textContent = value === 1 ? I18N.node : I18N.nodes;
          }
          if (mergeThresholdText instanceof HTMLElement) {
            mergeThresholdText.textContent = mergeThresholdDescription(value);
          }
        };
        if (mergeThresholdInput instanceof HTMLInputElement) {
          mergeThresholdInput.addEventListener("input", syncMergeThreshold);
          mergeThresholdInput.addEventListener("change", syncMergeThreshold);
          syncMergeThreshold();
        }

        const toggles = page.querySelectorAll("[data-flag-toggle]");
        toggles.forEach((toggle) => {
          if (!(toggle instanceof HTMLElement)) {
            return;
          }
          const targetId = toggle.getAttribute("data-flag-toggle");
          if (!targetId) {
            return;
          }
          const toggleInput = page.querySelector(`#${targetId}`);
          if (!(toggleInput instanceof HTMLInputElement)) {
            return;
          }
          const animate = () => {
            const card = toggle.closest("[data-flag-item]");
            if (!card) {
              return;
            }
            card.classList.remove("is-animating");
            void card.offsetWidth;
            card.classList.add("is-animating");
          };
          toggle.addEventListener("click", () => {
            toggleInput.disabled = !toggleInput.disabled;
            updateToggle(toggle, toggleInput);
            animate();
          });
          updateToggle(toggle, toggleInput);
        });

        const overlapTeamToggles = page.querySelectorAll("[data-overlap-team-toggle]");
        overlapTeamToggles.forEach((toggle) => {
          if (!(toggle instanceof HTMLButtonElement)) {
            return;
          }
          toggle.addEventListener("click", () => {
            const card = toggle.closest("[data-overlap-team-card]");
            if (!(card instanceof HTMLElement)) {
              return;
            }
            const isOpen = card.classList.toggle("is-open");
            toggle.setAttribute("aria-expanded", isOpen ? "true" : "false");
          });
        });

        const toNumber = (value) => {
          const parsed = Number(value);
          return Number.isFinite(parsed) ? parsed : 0;
        };

        const scopedNodes = (root, selector) =>
          Array.from(root.querySelectorAll(selector)).filter(
            (node) => node.closest("[data-sortable-table]") === root,
          );

        const setupSortableTables = () => {
          const sortableTables = page.querySelectorAll("[data-sortable-table]");
          sortableTables.forEach((table) => {
            if (!(table instanceof HTMLElement) || table.dataset.sortInit === "true") {
              return;
            }

            const sortItemsContainers = scopedNodes(table, "[data-sort-items]");
            const sortItemsContainer = sortItemsContainers[0];
            if (!(sortItemsContainer instanceof HTMLElement)) {
              return;
            }
            const triggers = scopedNodes(table, "[data-sort-trigger]");
            if (!triggers.length) {
              return;
            }

            const getItems = () =>
              Array.from(sortItemsContainer.querySelectorAll("[data-sort-item]")).filter(
                (node) => node instanceof HTMLElement,
              );
            getItems().forEach((item, index) => {
              item.dataset.sortIndex = String(index);
            });

            const setTriggerState = (activeKey, order) => {
              triggers.forEach((trigger) => {
                if (!(trigger instanceof HTMLElement)) {
                  return;
                }
                const key = trigger.getAttribute("data-sort-key");
                const isActive = !!activeKey && key === activeKey;
                trigger.dataset.sortActive = isActive ? "true" : "false";
                trigger.dataset.sortOrder = isActive ? order : "";
                trigger.setAttribute("aria-pressed", isActive ? "true" : "false");
              });
            };

            const runSort = (key, type, order) => {
              const items = getItems();
              items.sort((left, right) => {
                const leftRaw = left.getAttribute(`data-sort-${key}`) || "";
                const rightRaw = right.getAttribute(`data-sort-${key}`) || "";
                const leftValue =
                  type === "number" ? toNumber(leftRaw) : leftRaw.trim().toLocaleLowerCase();
                const rightValue =
                  type === "number" ? toNumber(rightRaw) : rightRaw.trim().toLocaleLowerCase();

                if (leftValue < rightValue) {
                  return order === "asc" ? -1 : 1;
                }
                if (leftValue > rightValue) {
                  return order === "asc" ? 1 : -1;
                }

                return toNumber(left.dataset.sortIndex) - toNumber(right.dataset.sortIndex);
              });
              items.forEach((item) => {
                sortItemsContainer.appendChild(item);
              });
              items.forEach((item, index) => {
                const rankNodes = item.querySelectorAll("[data-sort-rank]");
                rankNodes.forEach((rankNode) => {
                  if (!(rankNode instanceof HTMLElement)) {
                    return;
                  }
                  const prefix = rankNode.getAttribute("data-sort-rank-prefix") || "";
                  const suffix = rankNode.getAttribute("data-sort-rank-suffix") || "";
                  rankNode.textContent = `${prefix}${index + 1}${suffix}`;
                });
              });
              setTriggerState(key, order);
              table.dispatchEvent(new CustomEvent("teamgraph:sorted"));
            };

            triggers.forEach((trigger) => {
              if (!(trigger instanceof HTMLElement)) {
                return;
              }
              trigger.addEventListener("click", () => {
                const key = trigger.getAttribute("data-sort-key");
                if (!key) {
                  return;
                }
                const type = trigger.getAttribute("data-sort-type") || "number";
                const defaultOrder = trigger.getAttribute("data-sort-default-order") || "desc";
                const isActive = trigger.dataset.sortActive === "true";
                const currentOrder = trigger.dataset.sortOrder || "";
                const nextOrder =
                  isActive && currentOrder === defaultOrder
                    ? defaultOrder === "desc"
                      ? "asc"
                      : "desc"
                    : defaultOrder;
                runSort(key, type, nextOrder);
              });
            });

            table.dataset.sortInit = "true";
          });
        };

        const setupOverlapVisibility = () => {
          const overlapTable = page.querySelector("[data-overlap-sortable]");
          if (!(overlapTable instanceof HTMLElement)) {
            return;
          }
          const overlapTeamsList = overlapTable.querySelector("[data-overlap-team-list]");
          if (!(overlapTeamsList instanceof HTMLElement)) {
            return;
          }
          const overlapMoreToggle = overlapTable.querySelector("[data-overlap-more-toggle]");
          const visibleLimit = Math.max(1, toNumber(overlapTable.getAttribute("data-overlap-limit")));
          const lessLabel = I18N.showFewerTeams;

          const updateTeamsVisibility = () => {
            const cards = Array.from(overlapTeamsList.querySelectorAll("[data-overlap-team-card]")).filter(
              (node) => node instanceof HTMLElement,
            );
            const hiddenCount = Math.max(0, cards.length - visibleLimit);
            const expanded =
              !(overlapMoreToggle instanceof HTMLButtonElement) ||
              overlapMoreToggle.getAttribute("aria-expanded") === "true";

            cards.forEach((card, index) => {
              card.hidden = !expanded && index >= visibleLimit;
              const rankNode = card.querySelector("[data-overlap-rank]");
              if (rankNode instanceof HTMLElement) {
                rankNode.textContent = `${index + 1}.`;
              }
            });

            if (overlapMoreToggle instanceof HTMLButtonElement) {
              overlapMoreToggle.hidden = hiddenCount === 0;
              overlapMoreToggle.textContent = expanded
                ? lessLabel
                : I18N.showMoreTeamsTemplate.replaceAll("__COUNT__", String(hiddenCount));
            }
          };

          if (overlapMoreToggle instanceof HTMLButtonElement) {
            overlapMoreToggle.addEventListener("click", () => {
              const isExpanded = overlapMoreToggle.getAttribute("aria-expanded") === "true";
              overlapMoreToggle.setAttribute("aria-expanded", isExpanded ? "false" : "true");
              updateTeamsVisibility();
            });
          }

          overlapTable.addEventListener("teamgraph:sorted", updateTeamsVisibility);
          updateTeamsVisibility();
        };

        const setupDashboardSections = () => {
          const sections = Array.from(
            page.querySelectorAll(".team-graph-dashboard-section-collapsible"),
          ).filter((node) => node instanceof HTMLDetailsElement);
          if (!sections.length) {
            return;
          }
          const dashboardSectionStorageKey = "team-graph:step4:dashboard-sections";

          const prefersReducedMotion =
            typeof window.matchMedia === "function" &&
            window.matchMedia("(prefers-reduced-motion: reduce)").matches;

          const readSectionState = () => {
            try {
              const raw = window.sessionStorage.getItem(dashboardSectionStorageKey);
              if (!raw) {
                return {};
              }
              const parsed = JSON.parse(raw);
              return parsed && typeof parsed === "object" ? parsed : {};
            } catch {
              return {};
            }
          };

          const writeSectionState = (nextState) => {
            try {
              window.sessionStorage.setItem(dashboardSectionStorageKey, JSON.stringify(nextState));
            } catch {
              // Ignore storage failures (private mode / disabled storage).
            }
          };

          const sectionState = readSectionState();

          const updateHint = (section) => {
            const hint = section.querySelector("[data-dashboard-summary-hint]");
            if (hint instanceof HTMLElement) {
              hint.textContent = section.open ? I18N.clickToCollapse : I18N.clickToExpand;
            }
          };

          sections.forEach((section, index) => {
            const summary = section.querySelector(".team-graph-dashboard-summary");
            const content = section.querySelector(".team-graph-dashboard-content");
            if (!(summary instanceof HTMLElement) || !(content instanceof HTMLElement)) {
              return;
            }
            const sectionKey = section.getAttribute("data-dashboard-section-key") || `section-${index + 1}`;

            if (Object.prototype.hasOwnProperty.call(sectionState, sectionKey)) {
              section.open = sectionState[sectionKey] === true;
            }

            updateHint(section);

            let isAnimating = false;
            const persistOpenState = (isOpen) => {
              sectionState[sectionKey] = isOpen;
              writeSectionState(sectionState);
            };
            summary.addEventListener("click", (event) => {
              event.preventDefault();
              if (isAnimating) {
                return;
              }

              const expand = !section.open;
              if (prefersReducedMotion || typeof section.animate !== "function") {
                section.open = expand;
                persistOpenState(expand);
                updateHint(section);
                return;
              }

              const startHeight = section.offsetHeight;
              if (expand) {
                section.open = true;
              }
              const endHeight = expand ? summary.offsetHeight + content.offsetHeight : summary.offsetHeight;

              isAnimating = true;
              const animation = section.animate(
                [{ height: `${startHeight}px` }, { height: `${endHeight}px` }],
                {
                  duration: 210,
                  easing: "cubic-bezier(0.2, 0.7, 0.2, 1)",
                },
              );

              section.style.height = `${startHeight}px`;
              section.style.overflow = "hidden";
              section.classList.add("is-animating");

              animation.onfinish = () => {
                if (!expand) {
                  section.open = false;
                }
                persistOpenState(expand);
                section.style.height = "";
                section.style.overflow = "";
                section.classList.remove("is-animating");
                updateHint(section);
                isAnimating = false;
              };

              animation.oncancel = () => {
                section.style.height = "";
                section.style.overflow = "";
                section.classList.remove("is-animating");
                isAnimating = false;
              };
            });
          });
        };

        setupSortableTables();
        setupOverlapVisibility();
        setupDashboardSections();

        const graphEntities = Array.from(
          page.querySelectorAll(".team-graph-graph-entity[data-team]"),
        ).filter((node) => node instanceof HTMLElement);
        const normalizeTeamName = (value) => value.trim().replace(/\s+/g, " ").toLocaleLowerCase();
        const hueForTeam = (teamName) => {
          let hash = 0;
          for (let index = 0; index < teamName.length; index += 1) {
            hash = (hash * 31 + teamName.charCodeAt(index)) % 3600;
          }
          return Math.round((hash / 10) % 360);
        };
        graphEntities.forEach((node) => {
          const teamName = normalizeTeamName(node.getAttribute("data-team") || "");
          if (!teamName) {
            return;
          }
          const shouldColorize =
            node.getAttribute("data-colorize-team") === "true" ||
            !!node.closest(".team-graph-graphs-item.is-merged");
          if (!shouldColorize) {
            node.style.removeProperty("--team-chip-border");
            node.style.removeProperty("--team-chip-bg");
            node.style.removeProperty("--team-chip-team-bg");
            node.style.removeProperty("--team-chip-team-text");
            return;
          }
          const hue = hueForTeam(teamName);
          node.style.setProperty("--team-chip-border", `hsla(${hue}, 82%, 66%, 0.45)`);
          node.style.setProperty("--team-chip-bg", `hsla(${hue}, 80%, 44%, 0.12)`);
          node.style.setProperty("--team-chip-team-bg", `hsla(${hue}, 88%, 62%, 0.24)`);
          node.style.setProperty("--team-chip-team-text", `hsl(${hue} 100% 85%)`);
        });

        page.dataset.initialized = "true";
      };

      document.addEventListener("DOMContentLoaded", initTeamGraphPage);
      document.body.addEventListener("htmx:afterSwap", (event) => {
        if (!(event.target instanceof HTMLElement)) {
          return;
        }
        if (event.target.id !== "team-graph-page") {
          return;
        }
        initTeamGraphPage();
      });
      initTeamGraphPage();
    })();
  </script>
{% endblock %}

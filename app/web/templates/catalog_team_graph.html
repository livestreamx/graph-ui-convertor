{% extends "base.html" %}

{% block content %}
  <section class="detail-header">
    <a class="ghost-button" href="/catalog">Back to catalog</a>
    <div class="detail-title">Cross-team procedure graphs</div>
    <div class="detail-meta">
      <span>Build combined procedure graphs across selected teams.</span>
    </div>
  </section>

  <section class="team-graph-page">
    <div class="detail-card team-graph-card">
      <div class="team-graph-header">
        <div>
          <h3>Build graphs</h3>
          <p class="team-graph-subtitle">
            Select teams to merge their <code>procedure_graph</code> into a single overview.
          </p>
        </div>
        <div class="team-graph-header-actions">
          <div class="team-graph-help">
            <button class="team-graph-help-button" type="button" aria-label="Teams in graph">?</button>
            <div class="team-graph-help-popover">
              <div class="team-graph-help-title">Teams in graph</div>
              {% if selected_teams %}
                <div class="team-graph-summary">
                  <div class="team-graph-summary-item">
                    <span class="team-graph-summary-value">{{ selected_team_count }}</span>
                    <span class="team-graph-summary-label">teams</span>
                  </div>
                  <div class="team-graph-summary-item">
                    <span class="team-graph-summary-value">{{ selected_markups_count }}</span>
                    <span class="team-graph-summary-label">markups merged</span>
                  </div>
                </div>
              {% endif %}
              <div class="team-chip-grid team-chip-grid-compact">
                {% if selected_teams %}
                  {% for team in selected_teams %}
                    <div class="team-chip">
                      <div class="team-chip-name">{{ team.label }}</div>
                      <div class="team-chip-id">{{ team.id }}</div>
                      <div class="team-chip-count">
                        {{ team.markup_count }} markup{% if team.markup_count != 1 %}s{% endif %}
                      </div>
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="team-chip-empty">Select teams to build a combined graph.</div>
                {% endif %}
              </div>
              <div class="team-graph-help-hint">
                Builds a procedure-level graph using <code>procedure_graph</code> across selected teams.
              </div>
            </div>
          </div>
        </div>
      </div>
      <form class="team-graph-form" id="team-graph-form" action="/catalog/teams/graph" method="get">
        <label class="filter-control">
          <span>Select teams</span>
          <select id="team-graph-select" multiple size="8" form="team-graph-form">
            {% for team_key, team_label in team_options %}
              <option value="{{ team_key }}" {% if team_key in team_ids %}selected{% endif %}>
                {{ team_label }}
              </option>
            {% endfor %}
          </select>
        </label>
        <input
          type="hidden"
          id="team-graph-input"
          name="team_ids"
          value="{{ team_ids | join(',') }}"
        />
      </form>
    </div>

    <div class="detail-card team-graph-flags-card">
      <div class="team-graph-flags-header">
        <h3>Feature flags</h3>
        <p class="team-graph-subtitle">
          Tune how merge nodes are detected before building the diagram.
        </p>
      </div>
      <div class="team-graph-flag-grid">
        <div class="team-graph-flag-item" data-flag-item>
          <div class="team-graph-flag-info">
            <div class="team-graph-flag-title">
              Use all available markups when rendering merge nodes.
            </div>
            <div class="team-graph-flag-text">
              Merge nodes are derived from the full catalog, while only selected teams render.
            </div>
          </div>
          <div class="team-graph-flag-action">
            <input
              class="team-graph-flag-input"
              type="checkbox"
              id="merge_nodes_all_markups"
              name="merge_nodes_all_markups"
              value="true"
              form="team-graph-form"
              {% if merge_nodes_all_markups %}checked{% endif %}
            />
            <button
              class="team-graph-flag-toggle"
              type="button"
              data-flag-toggle="merge_nodes_all_markups"
              aria-pressed="false"
            >
              <span class="team-graph-flag-toggle-label">Disabled</span>
              <span class="team-graph-flag-toggle-track">
                <span class="team-graph-flag-toggle-knob"></span>
              </span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="detail-card team-graph-result-card">
      <h3>Open the diagram</h3>
      <div class="team-graph-cta">
        <div class="team-graph-cta-copy">
          <div class="team-graph-cta-title">Merge selected teams</div>
          <div class="team-graph-cta-text">
            Once merged, the summary and open/download actions appear below.
          </div>
        </div>
        <button class="primary-button" type="submit" form="team-graph-form">Merge</button>
      </div>
      <div class="team-graph-result">
        {% if diagram_ready %}
          <div class="team-graph-result-header">
            <span class="team-graph-result-status team-graph-result-ready">Merge ready</span>
            {% if selected_team_count %}
              <span class="team-graph-result-meta">
                {{ selected_team_count }} teams Â· {{ selected_markups_count }} markups merged
              </span>
            {% endif %}
          </div>
          <div class="team-graph-result-body">
            Open the team graph in {{ diagram_label }} or download the file for manual import and
            editing.
          </div>
          {% if open_mode == "manual" %}
            <div class="team-graph-result-note">
              Scene is too large for URL sharing. Use Download + Import.
            </div>
          {% elif open_mode == "local_storage" %}
            <div class="team-graph-result-note">
              Scene is injected via local storage for same-origin {{ diagram_label }}.
            </div>
          {% else %}
            <div class="team-graph-result-note">
              If the scene does not load, import the downloaded file manually.
            </div>
          {% endif %}
        {% elif error_message %}
          <div class="team-graph-result-header">
            <span class="team-graph-result-status team-graph-result-error">Merge blocked</span>
          </div>
          <div class="team-graph-result-body">{{ error_message }}</div>
        {% else %}
          <div class="team-graph-result-header">
            <span class="team-graph-result-status team-graph-result-idle">Waiting for input</span>
          </div>
          <div class="team-graph-result-body">
            Select teams and click Merge. The merged graph details and actions will appear here.
          </div>
        {% endif %}
      </div>
      {% if diagram_ready %}
        <div class="button-row">
          <a class="primary-button" target="_blank" href="{{ diagram_open_url }}">
            Open {{ diagram_label }}
          </a>
          <a class="ghost-button" href="/api/teams/graph?{{ team_query }}&download=true">
            Download {{ diagram_ext }}
          </a>
        </div>
      {% endif %}
    </div>
  </section>

  <script>
    (() => {
      const form = document.getElementById("team-graph-form");
      const select = document.getElementById("team-graph-select");
      const input = document.getElementById("team-graph-input");
      if (!form || !select || !input) {
        return;
      }
      const sync = () => {
        const values = Array.from(select.selectedOptions).map((option) => option.value);
        input.value = values.join(",");
      };
      select.addEventListener("change", sync);
      form.addEventListener("submit", sync);
      sync();

      const toggles = document.querySelectorAll("[data-flag-toggle]");
      const updateToggle = (button, checkbox) => {
        const enabled = checkbox.checked === true;
        button.dataset.state = enabled ? "on" : "off";
        button.setAttribute("aria-pressed", enabled ? "true" : "false");
        const label = button.querySelector(".team-graph-flag-toggle-label");
        if (label) {
          label.textContent = enabled ? "Enabled" : "Disabled";
        }
        const card = button.closest("[data-flag-item]");
        if (card) {
          card.classList.toggle("is-on", enabled);
        }
      };
      toggles.forEach((toggle) => {
        if (!(toggle instanceof HTMLElement)) {
          return;
        }
        const targetId = toggle.getAttribute("data-flag-toggle");
        if (!targetId) {
          return;
        }
        const checkbox = document.getElementById(targetId);
        if (!(checkbox instanceof HTMLInputElement)) {
          return;
        }
        const animate = () => {
          toggle.classList.remove("is-animating");
          void toggle.offsetWidth;
          toggle.classList.add("is-animating");
        };
        toggle.addEventListener("click", () => {
          checkbox.checked = !checkbox.checked;
          updateToggle(toggle, checkbox);
          animate();
        });
        checkbox.addEventListener("change", () => updateToggle(toggle, checkbox));
        updateToggle(toggle, checkbox);
      });
    })();
  </script>
{% endblock %}

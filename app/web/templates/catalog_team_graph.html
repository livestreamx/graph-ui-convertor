{% extends "base.html" %}

{% macro render_team_service_entity(label, extra_class="", colorize=false) %}
  {% set parts = label.split(' / ', 1) %}
  <span class="team-graph-graph-entity {{ extra_class }}" data-team="{{ parts[0] }}" {% if colorize %}data-colorize-team="true"{% endif %}>
    <span class="team-graph-graph-entity-team">{{ parts[0] }}</span>
    <span class="team-graph-graph-entity-service">
      {% if parts|length > 1 %}
        {{ parts[1] }}
      {% else %}
        {{ label }}
      {% endif %}
    </span>
  </span>
{% endmacro %}

{% block content %}
  <section class="detail-header">
    <a class="ghost-button" href="/catalog">Back to catalog</a>
    <div class="detail-title">Cross-team graphs builder</div>
    <div class="detail-meta">
      <span>Build combined procedure graphs across selected teams.</span>
    </div>
  </section>

  <section class="team-graph-page" id="team-graph-page">
    <div class="detail-card team-graph-card">
      <div class="team-graph-header">
        <div>
          <h3>Step 1. Select teams</h3>
          <p class="team-graph-subtitle">
            Select teams to merge their <code>procedure_graph</code> into a single overview.
          </p>
        </div>
        <div class="team-graph-header-actions">
          <div class="team-graph-help">
            <button class="team-graph-help-button" type="button" aria-label="Teams in graph">?</button>
            <div class="team-graph-help-popover">
              <div class="team-graph-help-title">Teams in graph</div>
              {% if selected_teams %}
                <div class="team-graph-summary">
                  <div class="team-graph-summary-item">
                    <span class="team-graph-summary-value">{{ selected_team_count }}</span>
                    <span class="team-graph-summary-label">teams</span>
                  </div>
                  <div class="team-graph-summary-item">
                    <span class="team-graph-summary-value">{{ selected_markups_count }}</span>
                    <span class="team-graph-summary-label">markups merged</span>
                  </div>
                </div>
              {% endif %}
              <div class="team-chip-grid team-chip-grid-compact">
                {% if selected_teams %}
                  {% for team in selected_teams %}
                    <div class="team-chip">
                      <div class="team-chip-name">{{ team.label }}</div>
                      <div class="team-chip-id">{{ team.id }}</div>
                      <div class="team-chip-count">
                        {{ team.markup_count }} markup{% if team.markup_count != 1 %}s{% endif %}
                      </div>
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="team-chip-empty">Select teams to build a combined graph.</div>
                {% endif %}
              </div>
              <div class="team-graph-help-hint">
                Builds a procedure-level graph using <code>procedure_graph</code> across selected teams.
              </div>
            </div>
          </div>
        </div>
      </div>
      <form
        class="team-graph-form"
        id="team-graph-form"
        action="/catalog/teams/graph"
        method="get"
        hx-get="/catalog/teams/graph"
        hx-target="#team-graph-page"
        hx-select="#team-graph-page"
        hx-swap="outerHTML"
        hx-push-url="true"
        hx-indicator="#team-graph-merge-loader"
      >
        <label class="filter-control">
          <select id="team-graph-select" multiple size="8" form="team-graph-form">
            {% for team_key, team_label in team_options %}
              <option value="{{ team_key }}" {% if team_key in team_ids %}selected{% endif %}>
                {{ team_label }}
              </option>
            {% endfor %}
          </select>
        </label>
        <input
          type="hidden"
          id="team-graph-input"
          name="team_ids"
          value="{{ team_ids | join(',') }}"
        />
      </form>
    </div>

    <div class="detail-card team-graph-flags-card">
      <div class="team-graph-flags-header">
        <h3>Step 2. Feature flags</h3>
        <p class="team-graph-subtitle">
          Tune how selected markups render and how merge nodes are detected.
        </p>
      </div>
      <div class="team-graph-flag-grid">
        <div
          class="team-graph-flag-item {% if merge_selected_markups %}is-on{% endif %}"
          data-flag-item
        >
          <div class="team-graph-flag-header">
            <span
              class="team-graph-flag-status"
              data-flag-status
              data-state="{% if merge_selected_markups %}on{% else %}off{% endif %}"
            >
              {% if merge_selected_markups %}Enabled{% else %}Disabled{% endif %}
            </span>
          </div>
          <div class="team-graph-flag-title">
            Merge markups by shared nodes
          </div>
          <div class="team-graph-flag-text">
            How selected graphs render their components in according to shared nodes.
          </div>
          <div class="team-graph-flag-action">
            <button
              class="primary-button team-graph-flag-button"
              type="button"
              data-flag-toggle="merge_selected_markups"
              data-state="{% if merge_selected_markups %}on{% else %}off{% endif %}"
              aria-pressed="{% if merge_selected_markups %}true{% else %}false{% endif %}"
            >
              {% if merge_selected_markups %}Disable{% else %}Enable{% endif %}
            </button>
          </div>
          <input
            type="hidden"
            id="merge_selected_markups"
            name="merge_selected_markups"
            value="true"
            form="team-graph-form"
            {% if not merge_selected_markups %}disabled{% endif %}
          />
        </div>
        <div
          class="team-graph-flag-item {% if merge_nodes_all_markups %}is-on{% endif %}"
          data-flag-item
        >
          <div class="team-graph-flag-header">
            <span
              class="team-graph-flag-status"
              data-flag-status
              data-state="{% if merge_nodes_all_markups %}on{% else %}off{% endif %}"
            >
              {% if merge_nodes_all_markups %}Enabled{% else %}Disabled{% endif %}
            </span>
          </div>
          <div class="team-graph-flag-title">
            Render merge nodes from all available markups
          </div>
          <div class="team-graph-flag-text">
            Merge nodes are derived from the full catalog, while only selected teams render.
          </div>
          <div class="team-graph-flag-action">
            <button
              class="primary-button team-graph-flag-button"
              type="button"
              data-flag-toggle="merge_nodes_all_markups"
              data-state="{% if merge_nodes_all_markups %}on{% else %}off{% endif %}"
              aria-pressed="{% if merge_nodes_all_markups %}true{% else %}false{% endif %}"
            >
              {% if merge_nodes_all_markups %}Disable{% else %}Enable{% endif %}
            </button>
          </div>
          <input
            type="hidden"
            id="merge_nodes_all_markups"
            name="merge_nodes_all_markups"
            value="true"
            form="team-graph-form"
            {% if not merge_nodes_all_markups %}disabled{% endif %}
          />
        </div>
      </div>
    </div>

    <div class="detail-card team-graph-result-card">
      <h3>Step 3. Merge graphs</h3>
      <div class="team-graph-cta">
          <div class="team-graph-cta-copy">
            <div class="team-graph-cta-title">Merge selected teams</div>
            <div class="team-graph-cta-text">
              Once merged, the summary appears here and actions become available in Step 4.
            </div>
          </div>
        <div class="team-graph-cta-action">
          <button
            class="primary-button team-graph-merge-button"
            type="submit"
            form="team-graph-form"
            data-merge-button
            {% if not team_ids %}disabled aria-disabled="true"{% endif %}
          >
            Merge
          </button>
        </div>
      </div>
      <div
        class="team-graph-cta-warning {% if team_ids %}is-hidden{% endif %}"
        data-team-required-message
        role="status"
        aria-live="polite"
      >
        Select at least one team to enable Merge.
      </div>
      <div class="team-graph-merge-loader" id="team-graph-merge-loader" aria-live="polite">
        <div class="team-graph-merge-loader-spinner" aria-hidden="true"></div>
        <div class="team-graph-merge-loader-copy">
          <div class="team-graph-merge-loader-title">Merging selected graphs</div>
          <div class="team-graph-merge-loader-text">
            Mapping shared nodes and building a cross-team dashboard...
          </div>
        </div>
      </div>
      <div class="team-graph-result">
        {% if diagram_ready %}
          <div class="team-graph-result-header">
            <span class="team-graph-result-status team-graph-result-ready">Merge ready</span>
            {% if selected_team_count %}
              <span class="team-graph-result-meta">
                {{ selected_team_count }} teams · {{ selected_markups_count }} markups merged
              </span>
            {% endif %}
          </div>
          <div class="team-graph-result-body">
            Open the team graph in {{ diagram_label }} or download the file for manual import and
            editing.
          </div>
          {% if open_mode == "manual" %}
            <div class="team-graph-result-note">
              Scene is too large for URL sharing. Use Download + Import.
            </div>
          {% elif open_mode == "local_storage" %}
            <div class="team-graph-result-note">
              Scene is injected via local storage for same-origin {{ diagram_label }}.
            </div>
          {% else %}
            <div class="team-graph-result-note">
              If the scene does not load, import the downloaded file manually.
            </div>
          {% endif %}
          {% if team_dashboard %}
            {% set total_procedures = team_dashboard.total_procedure_count %}
            {% set total_services = team_dashboard.total_service_count %}
            <section class="team-graph-dashboard">
              <div class="team-graph-dashboard-section">
                <div class="team-graph-dashboard-title">Graphs info</div>
                <div class="team-graph-dashboard-grid">
                  <article class="team-graph-kpi-card">
                    <div class="team-graph-kpi-head">
                      <div class="team-graph-kpi-label">Graphs</div>
                      <div class="team-graph-help team-graph-help-inline">
                        <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="Graphs help">?</button>
                        <div class="team-graph-help-popover team-graph-help-popover-wide">
                          <div class="team-graph-help-title">Unique graphs</div>
                          <div class="team-graph-help-hint">Count of unique graphs from selected teams.</div>
                        </div>
                      </div>
                    </div>
                    <div class="team-graph-kpi-value">{{ team_dashboard.unique_graph_count }}</div>
                    <div class="team-graph-kpi-note">Detailed list is shown below.</div>
                  </article>
                  <article class="team-graph-kpi-card team-graph-kpi-card-drilldown">
                    <div class="team-graph-kpi-head">
                      <div class="team-graph-kpi-label">Bot graphs</div>
                      <div class="team-graph-help team-graph-help-inline">
                        <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="Bot graphs help">?</button>
                        <div class="team-graph-help-popover team-graph-help-popover-wide">
                          <div class="team-graph-help-title">Bot graphs</div>
                          <div class="team-graph-help-hint">Graphs where at least one <code>procedure_id</code> contains <code>bot</code>.</div>
                        </div>
                      </div>
                    </div>
                    <div class="team-graph-kpi-value">{{ team_dashboard.bot_graph_count }}</div>
                    {% if team_dashboard.bot_graphs %}
                      <div class="team-graph-hover-list">
                        {% for item in team_dashboard.bot_graphs %}
                          <div class="team-graph-hover-item">{{ item }}</div>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </article>
                  <article class="team-graph-kpi-card team-graph-kpi-card-drilldown">
                    <div class="team-graph-kpi-head">
                      <div class="team-graph-kpi-label">Multi graphs</div>
                      <div class="team-graph-help team-graph-help-inline">
                        <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="Multi graphs help">?</button>
                        <div class="team-graph-help-popover team-graph-help-popover-wide">
                          <div class="team-graph-help-title">Multichannel graphs</div>
                          <div class="team-graph-help-hint">Graphs where at least one <code>procedure_id</code> contains <code>multi</code>.</div>
                        </div>
                      </div>
                    </div>
                    <div class="team-graph-kpi-value">{{ team_dashboard.multi_graph_count }}</div>
                    {% if team_dashboard.multi_graphs %}
                      <div class="team-graph-hover-list">
                        {% for item in team_dashboard.multi_graphs %}
                          <div class="team-graph-hover-item">{{ item }}</div>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </article>
                  <article class="team-graph-kpi-card">
                    <div class="team-graph-kpi-head">
                      <div class="team-graph-kpi-label">Unique procedures</div>
                      <div class="team-graph-help team-graph-help-inline">
                        <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="Unique procedures help">?</button>
                        <div class="team-graph-help-popover team-graph-help-popover-wide">
                          <div class="team-graph-help-title">Unique procedures</div>
                          <div class="team-graph-help-hint">Unique <code>procedure_id</code> count across all selected markups.</div>
                        </div>
                      </div>
                    </div>
                    <div class="team-graph-kpi-value">{{ team_dashboard.unique_procedure_count }}</div>
                  </article>
                </div>
                <article class="team-graph-data-card team-graph-graphs-details-card">
                  <div class="team-graph-data-head">
                    <div class="team-graph-data-title">Graphs and intersections details</div>
                    <div class="team-graph-help team-graph-help-inline">
                      <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="Graphs and intersections details help">?</button>
                      <div class="team-graph-help-popover team-graph-help-popover-wide">
                        <div class="team-graph-help-title">Graphs and intersections details</div>
                        <div class="team-graph-help-hint">Grouped by markup or by unique merged-markup combination, ranked by graph count.</div>
                      </div>
                    </div>
                  </div>
                  {% if team_dashboard.graph_groups %}
                    <div class="team-graph-graphs-list">
                      <div class="team-graph-graphs-row team-graph-graphs-row-header">
                        <span>Graphs</span>
                        <span>Count</span>
                      </div>
                      {% for item in team_dashboard.graph_groups %}
                        {% set entities = item.label.split(' + ') %}
                        <div class="team-graph-graphs-row team-graph-graphs-item {% if entities|length > 1 %}is-merged{% endif %}" data-graph-group-size="{{ entities|length }}">
                          <span class="team-graph-graph-entities">
                            {% for entity in entities %}
                              {{ render_team_service_entity(entity, colorize=entities|length > 1) }}
                              {% if not loop.last %}
                                <span class="team-graph-graph-separator" aria-hidden="true">x</span>
                              {% endif %}
                            {% endfor %}
                          </span>
                          <span class="team-graph-graphs-count">
                            <span class="team-graph-graphs-count-value">{{ item.graph_count }}</span>
                            <span class="team-graph-graphs-count-label">graph{% if item.graph_count != 1 %}s{% endif %}</span>
                          </span>
                        </div>
                      {% endfor %}
                    </div>
                  {% else %}
                    <div class="team-graph-empty">No graphs detected for selected markups.</div>
                  {% endif %}
                </article>
                <div class="team-graph-split-grid">
                  <article class="team-graph-data-card">
                    <div class="team-graph-data-head">
                      <div class="team-graph-data-title">Markup types</div>
                      <div class="team-graph-help team-graph-help-inline">
                        <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="Markup types help">?</button>
                        <div class="team-graph-help-popover team-graph-help-popover-wide">
                          <div class="team-graph-help-title">Markup types</div>
                          <div class="team-graph-help-hint">Total selected markups split by <code>markup_type</code>.</div>
                        </div>
                      </div>
                    </div>
                    <div class="team-graph-chip-row">
                      {% for stat in team_dashboard.markup_type_counts %}
                        <span class="team-graph-chip team-graph-chip-drilldown">
                          {{ stat.markup_type }} · {{ stat.count }}
                          {% if stat.item_labels %}
                            <span class="team-graph-chip-list">
                              {% for item in stat.item_labels %}
                                <span class="team-graph-chip-list-item">
                                  {{ render_team_service_entity(item, "team-graph-graph-entity-sm") }}
                                </span>
                              {% endfor %}
                            </span>
                          {% endif %}
                        </span>
                      {% endfor %}
                    </div>
                  </article>
                  <article class="team-graph-data-card">
                    <div class="team-graph-data-head">
                      <div class="team-graph-data-title">Procedure mix</div>
                      <div class="team-graph-help team-graph-help-inline">
                        <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="Procedure mix help">?</button>
                        <div class="team-graph-help-popover team-graph-help-popover-wide">
                          <div class="team-graph-help-title">Procedure mix</div>
                          <div class="team-graph-help-hint">Share among all procedures in selected markups by <code>procedure_id</code> substring: <code>bot</code>, <code>multi</code>, and everything else is employee procedures.</div>
                        </div>
                      </div>
                    </div>
                    <div class="team-graph-inline-metric team-graph-inline-metric-drilldown">
                      <span class="team-graph-inline-metric-label">Bot procedures</span>
                      <span class="team-graph-inline-metric-value">
                        {% if total_procedures %}
                          {{ (team_dashboard.bot_procedure_count * 100 / total_procedures) | round(1) }}%
                        {% else %}
                          0%
                        {% endif %}
                      </span>
                      <span class="team-graph-inline-metric-note">{{ team_dashboard.bot_procedure_count }} / {{ total_procedures }}</span>
                      {% if team_dashboard.bot_procedures %}
                        <div class="team-graph-hover-list team-graph-hover-list-inline">
                          {% for item in team_dashboard.bot_procedures %}
                            <div class="team-graph-hover-item team-graph-mono">{{ item }}</div>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                    <div class="team-graph-inline-metric team-graph-inline-metric-drilldown">
                      <span class="team-graph-inline-metric-label">Multichannel procedures</span>
                      <span class="team-graph-inline-metric-value">
                        {% if total_procedures %}
                          {{ (team_dashboard.multi_procedure_count * 100 / total_procedures) | round(1) }}%
                        {% else %}
                          0%
                        {% endif %}
                      </span>
                      <span class="team-graph-inline-metric-note">{{ team_dashboard.multi_procedure_count }} / {{ total_procedures }}</span>
                      {% if team_dashboard.multi_procedures %}
                        <div class="team-graph-hover-list team-graph-hover-list-inline">
                          {% for item in team_dashboard.multi_procedures %}
                            <div class="team-graph-hover-item team-graph-mono">{{ item }}</div>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                    <div class="team-graph-inline-metric team-graph-inline-metric-drilldown">
                      <span class="team-graph-inline-metric-label">Employee procedures</span>
                      <span class="team-graph-inline-metric-value">
                        {% if total_procedures %}
                          {{ (team_dashboard.employee_procedure_count * 100 / total_procedures) | round(1) }}%
                        {% else %}
                          0%
                        {% endif %}
                      </span>
                      <span class="team-graph-inline-metric-note">{{ team_dashboard.employee_procedure_count }} / {{ total_procedures }}</span>
                      {% if team_dashboard.employee_procedures %}
                        <div class="team-graph-hover-list team-graph-hover-list-inline">
                          {% for item in team_dashboard.employee_procedures %}
                            <div class="team-graph-hover-item team-graph-mono">{{ item }}</div>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                  </article>
                </div>
              </div>

              <div class="team-graph-dashboard-section">
                <div class="team-graph-dashboard-title">Entity Integrity</div>
                <div class="team-graph-dashboard-grid">
                  <article class="team-graph-kpi-card team-graph-kpi-card-drilldown">
                    <div class="team-graph-kpi-head">
                      <div class="team-graph-kpi-label">Internal overlap entities</div>
                      <div class="team-graph-help team-graph-help-inline">
                        <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="Internal overlap help">?</button>
                        <div class="team-graph-help-popover team-graph-help-popover-wide">
                          <div class="team-graph-help-title">Internal overlap entities</div>
                          <div class="team-graph-help-hint">Entities that share at least one procedure with another selected entity.</div>
                        </div>
                      </div>
                    </div>
                    <div class="team-graph-kpi-value">
                      {{ team_dashboard.internal_intersection_markup_count }}
                    </div>
                    {% if team_dashboard.internal_intersection_entities %}
                      <div class="team-graph-hover-list">
                        {% for item in team_dashboard.internal_intersection_entities %}
                          <div class="team-graph-hover-item">
                            {{ render_team_service_entity(item, "team-graph-graph-entity-sm", true) }}
                          </div>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </article>
                  <article class="team-graph-kpi-card team-graph-kpi-card-drilldown">
                    <div class="team-graph-kpi-head">
                      <div class="team-graph-kpi-label">External overlap entities</div>
                      <div class="team-graph-help team-graph-help-inline">
                        <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="External overlap help">?</button>
                        <div class="team-graph-help-popover team-graph-help-popover-wide">
                          <div class="team-graph-help-title">External overlap entities</div>
                          <div class="team-graph-help-hint">Entities that intersect with at least one entity from teams outside selection.</div>
                        </div>
                      </div>
                    </div>
                    <div class="team-graph-kpi-value">
                      {{ team_dashboard.external_intersection_markup_count }}
                    </div>
                    {% if team_dashboard.external_intersection_entities %}
                      <div class="team-graph-hover-list">
                        {% for item in team_dashboard.external_intersection_entities %}
                          <div class="team-graph-hover-item">
                            {{ render_team_service_entity(item, "team-graph-graph-entity-sm", true) }}
                          </div>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </article>
                  <article class="team-graph-kpi-card team-graph-kpi-card-drilldown">
                    <div class="team-graph-kpi-head">
                      <div class="team-graph-kpi-label">Split entities</div>
                      <div class="team-graph-help team-graph-help-inline">
                        <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="Split entities help">?</button>
                        <div class="team-graph-help-popover team-graph-help-popover-wide">
                          <div class="team-graph-help-title">Split entities</div>
                          <div class="team-graph-help-hint">Entities with more than one disconnected component in their procedure graph.</div>
                        </div>
                      </div>
                    </div>
                    <div class="team-graph-kpi-value">{{ team_dashboard.split_service_count }}</div>
                    {% if team_dashboard.split_entities %}
                      <div class="team-graph-hover-list">
                        {% for item in team_dashboard.split_entities %}
                          <div class="team-graph-hover-item">
                            {{ render_team_service_entity(item, "team-graph-graph-entity-sm") }}
                          </div>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </article>
                  <article class="team-graph-kpi-card team-graph-kpi-card-drilldown">
                    <div class="team-graph-kpi-head">
                      <div class="team-graph-kpi-label">Target entities</div>
                      <div class="team-graph-help team-graph-help-inline">
                        <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="Target entities help">?</button>
                        <div class="team-graph-help-popover team-graph-help-popover-wide">
                          <div class="team-graph-help-title">Target entities</div>
                          <div class="team-graph-help-hint">Entities without overlaps with other entities and without disconnected parts.</div>
                        </div>
                      </div>
                    </div>
                    <div class="team-graph-kpi-value">
                      {% if total_services %}
                        {{ (team_dashboard.target_service_count * 100 / total_services) | round(1) }}%
                      {% else %}
                        0%
                      {% endif %}
                    </div>
                    <div class="team-graph-kpi-note">{{ team_dashboard.target_service_count }} / {{ total_services }}</div>
                    {% if team_dashboard.target_entities %}
                      <div class="team-graph-hover-list">
                        {% for item in team_dashboard.target_entities %}
                          <div class="team-graph-hover-item">
                            {{ render_team_service_entity(item, "team-graph-graph-entity-sm") }}
                          </div>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </article>
                </div>
                <article class="team-graph-data-card">
                  <div class="team-graph-data-head">
                    <div class="team-graph-data-title">External team overlaps</div>
                    <div class="team-graph-help team-graph-help-inline">
                      <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="External team overlaps help">?</button>
                      <div class="team-graph-help-popover team-graph-help-popover-wide">
                        <div class="team-graph-help-title">External team overlaps</div>
                        <div class="team-graph-help-hint">Teams outside selection are ranked by total merge intersections with a split by dependency direction: external team depends on selected teams, and selected teams depend on external team. Click a team row to view service-level details.</div>
                      </div>
                    </div>
                  </div>
                  {% if team_dashboard.external_team_intersections %}
                    {% set top_external_teams = team_dashboard.external_team_intersections[:10] %}
                    {% set hidden_external_teams = team_dashboard.external_team_intersections[10:] %}
                    <div class="team-graph-ranked-list team-graph-overlap-list">
                      <div class="team-graph-overlap-row team-graph-overlap-row-header">
                        <span>Team</span>
                        <span>External &rarr; selected</span>
                        <span>Selected &rarr; external</span>
                        <span>Total</span>
                      </div>
                      {% for item in top_external_teams %}
                        {% set rank = loop.index %}
                        <div class="team-graph-overlap-team" data-overlap-team-card>
                          <button
                            class="team-graph-overlap-row team-graph-overlap-toggle-row"
                            type="button"
                            data-overlap-team-toggle
                            aria-expanded="false"
                          >
                            <span class="team-graph-overlap-main-label">{{ rank }}. {{ item.team_name }}</span>
                            <span class="team-graph-overlap-value">{{ item.external_depends_on_selected_count }}</span>
                            <span class="team-graph-overlap-value">{{ item.selected_depends_on_external_count }}</span>
                            <span class="team-graph-overlap-value">{{ item.count }}</span>
                          </button>
                          {% if item.services %}
                            <div class="team-graph-overlap-entities" data-overlap-team-details>
                              {% for service in item.services %}
                                <div class="team-graph-overlap-row team-graph-overlap-row-service">
                                  <span class="team-graph-overlap-service">
                                    {{ render_team_service_entity(item.team_name ~ ' / ' ~ service.service_name, "team-graph-graph-entity-sm", true) }}
                                  </span>
                                  <span class="team-graph-overlap-count">{{ service.external_depends_on_selected_count }}</span>
                                  <span class="team-graph-overlap-count">{{ service.selected_depends_on_external_count }}</span>
                                  <span class="team-graph-overlap-count">{{ service.count }}</span>
                                </div>
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      {% endfor %}
                      {% if hidden_external_teams %}
                        <div class="team-graph-overlap-more" data-overlap-more-list hidden>
                          {% for item in hidden_external_teams %}
                            {% set rank = loop.index + 10 %}
                            <div class="team-graph-overlap-team" data-overlap-team-card>
                              <button
                                class="team-graph-overlap-row team-graph-overlap-toggle-row"
                                type="button"
                                data-overlap-team-toggle
                                aria-expanded="false"
                              >
                                <span class="team-graph-overlap-main-label">{{ rank }}. {{ item.team_name }}</span>
                                <span class="team-graph-overlap-value">{{ item.external_depends_on_selected_count }}</span>
                                <span class="team-graph-overlap-value">{{ item.selected_depends_on_external_count }}</span>
                                <span class="team-graph-overlap-value">{{ item.count }}</span>
                              </button>
                              {% if item.services %}
                                <div class="team-graph-overlap-entities" data-overlap-team-details>
                                  {% for service in item.services %}
                                    <div class="team-graph-overlap-row team-graph-overlap-row-service">
                                      <span class="team-graph-overlap-service">
                                        {{ render_team_service_entity(item.team_name ~ ' / ' ~ service.service_name, "team-graph-graph-entity-sm", true) }}
                                      </span>
                                      <span class="team-graph-overlap-count">{{ service.external_depends_on_selected_count }}</span>
                                      <span class="team-graph-overlap-count">{{ service.selected_depends_on_external_count }}</span>
                                      <span class="team-graph-overlap-count">{{ service.count }}</span>
                                    </div>
                                  {% endfor %}
                                </div>
                              {% endif %}
                            </div>
                          {% endfor %}
                        </div>
                        <button class="team-graph-overlap-more-button" type="button" data-overlap-more-toggle aria-expanded="false">
                          More
                        </button>
                      {% endif %}
                    </div>
                  {% else %}
                    <div class="team-graph-empty">No intersections with teams outside the selection.</div>
                  {% endif %}
                </article>
              </div>

              <div class="team-graph-dashboard-section">
                <div class="team-graph-dashboard-title">Risk Hotspots</div>
                <article class="team-graph-data-card">
                  <div class="team-graph-data-head">
                    <div class="team-graph-data-title">Top linking procedures</div>
                    <div class="team-graph-help team-graph-help-inline">
                      <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="Top linking procedures help">?</button>
                      <div class="team-graph-help-popover team-graph-help-popover-wide">
                        <div class="team-graph-help-title">Top linking procedures</div>
                        <div class="team-graph-help-hint">Rank by reuse across graphs and by total in/out dependencies. Click a row to view exact graph labels.</div>
                      </div>
                    </div>
                  </div>
                  {% if team_dashboard.linking_procedures %}
                    <div class="team-graph-ranked-table">
                      <div class="team-graph-ranked-table-row team-graph-ranked-table-header">
                        <span>Procedure</span>
                        <span>Graphs</span>
                        <span>+Other graphs</span>
                        <span>Incoming</span>
                        <span>Outgoing</span>
                      </div>
                      {% for item in team_dashboard.linking_procedures %}
                        <details class="team-graph-ranked-table-item">
                          <summary class="team-graph-ranked-table-row">
                            <span class="team-graph-mono">{{ loop.index }}. {{ item.procedure_id }}</span>
                            <span>{{ item.graph_count }}</span>
                            <span>{{ item.usage_in_other_graphs }}</span>
                            <span>{{ item.incoming_edges }}</span>
                            <span>{{ item.outgoing_edges }}</span>
                          </summary>
                          <div class="team-graph-ranked-table-details">
                            <div class="team-graph-ranked-details-label">Used in graphs:</div>
                            <div class="team-graph-ranked-details-list">
                              {% for graph_label in item.graph_labels %}
                                <span>{{ graph_label }}</span>
                              {% endfor %}
                            </div>
                          </div>
                        </details>
                      {% endfor %}
                    </div>
                  {% else %}
                    <div class="team-graph-empty">No procedure-level data.</div>
                  {% endif %}
                </article>
                <article class="team-graph-data-card team-graph-data-card-spaced">
                  <div class="team-graph-data-head">
                    <div class="team-graph-data-title">Top overloaded entities</div>
                    <div class="team-graph-help team-graph-help-inline">
                      <button class="team-graph-help-button team-graph-help-button-sm" type="button" aria-label="Top overloaded entities help">?</button>
                      <div class="team-graph-help-popover team-graph-help-popover-wide">
                        <div class="team-graph-help-title">Top overloaded entities</div>
                        <div class="team-graph-help-hint">Rank by cycles, block count, in-team merge nodes, then procedure count. Click a row for detailed breakdown.</div>
                      </div>
                    </div>
                  </div>
                  {% if team_dashboard.overloaded_services %}
                    <div class="team-graph-ranked-table team-graph-ranked-table-services">
                      <div class="team-graph-ranked-table-row team-graph-ranked-table-header">
                        <span>Entity</span>
                        <span>Cycles</span>
                        <span>Blocks</span>
                        <span>In-team merges</span>
                        <span>Procedures</span>
                      </div>
                      {% for item in team_dashboard.overloaded_services %}
                        <details class="team-graph-ranked-table-item">
                          <summary class="team-graph-ranked-table-row">
                            <span>{{ render_team_service_entity(item.team_name ~ ' / ' ~ item.service_name, "team-graph-graph-entity-sm") }}</span>
                            <span>{{ item.cycle_count }}</span>
                            <span>{{ item.block_count }}</span>
                            <span>{{ item.in_team_merge_nodes }}</span>
                            <span>{{ item.procedure_count }}</span>
                          </summary>
                          <div class="team-graph-ranked-table-details">
                            <div class="team-graph-ranked-details-grid">
                              <div>
                                <div class="team-graph-ranked-details-label">Merge procedures</div>
                                <div class="team-graph-ranked-details-list team-graph-ranked-details-list-mono">
                                  {% if item.merge_node_ids %}
                                    {% for proc_id in item.merge_node_ids %}
                                      <span>{{ proc_id }}</span>
                                    {% endfor %}
                                  {% else %}
                                    <span>None</span>
                                  {% endif %}
                                </div>
                              </div>
                              <div>
                                <div class="team-graph-ranked-details-label">Cycle path</div>
                                <div class="team-graph-ranked-details-list team-graph-ranked-details-list-mono">
                                  {% if item.cycle_path %}
                                    <span>{{ item.cycle_path | join(' -> ') }}</span>
                                  {% else %}
                                    <span>No explicit cycle path</span>
                                  {% endif %}
                                </div>
                              </div>
                            </div>
                            <div class="team-graph-ranked-details-label">All procedures ({{ item.procedure_count }}), weak components: {{ item.weak_component_count }}</div>
                            <div class="team-graph-ranked-details-list team-graph-ranked-details-list-mono">
                              {% for proc_id in item.procedure_ids %}
                                <span>{{ proc_id }}</span>
                              {% endfor %}
                            </div>
                          </div>
                        </details>
                      {% endfor %}
                    </div>
                  {% else %}
                    <div class="team-graph-empty">No service-level data.</div>
                  {% endif %}
                </article>
              </div>
            </section>
          {% endif %}
        {% elif error_message %}
          <div class="team-graph-result-header">
            <span class="team-graph-result-status team-graph-result-error">Merge blocked</span>
          </div>
          <div class="team-graph-result-body">{{ error_message }}</div>
        {% else %}
          <div class="team-graph-result-header">
            <span class="team-graph-result-status team-graph-result-idle">Waiting for input</span>
          </div>
          <div class="team-graph-result-body">
            Select teams and click Merge. The merged graph details and actions will appear here.
          </div>
        {% endif %}
      </div>
    </div>

    <div class="detail-card team-graph-actions-card">
      <h3>Step 4. Use diagram</h3>
      {% if diagram_ready %}
        <div class="button-row">
          <a class="primary-button" target="_blank" href="{{ diagram_open_url }}">
            Open {{ diagram_label }}
          </a>
          <a class="ghost-button" href="/api/teams/graph?{{ team_query }}&download=true">
            Download {{ diagram_ext }}
          </a>
        </div>
      {% else %}
        <p class="team-graph-subtitle">Merge graphs in Step 3 to enable open/download actions.</p>
      {% endif %}
    </div>
  </section>

  <script>
    (() => {
      const updateToggle = (button, input) => {
        const enabled = input.disabled === false;
        button.dataset.state = enabled ? "on" : "off";
        button.setAttribute("aria-pressed", enabled ? "true" : "false");
        button.textContent = enabled ? "Disable" : "Enable";
        const card = button.closest("[data-flag-item]");
        if (card) {
          card.classList.toggle("is-on", enabled);
          const status = card.querySelector("[data-flag-status]");
          if (status) {
            status.textContent = enabled ? "Enabled" : "Disabled";
            status.dataset.state = enabled ? "on" : "off";
          }
        }
      };

        const initTeamGraphPage = () => {
        const page = document.getElementById("team-graph-page");
        if (!(page instanceof HTMLElement) || page.dataset.initialized === "true") {
          return;
        }

        const form = page.querySelector("#team-graph-form");
        const select = page.querySelector("#team-graph-select");
        const input = page.querySelector("#team-graph-input");
        if (
          !(form instanceof HTMLFormElement) ||
          !(select instanceof HTMLSelectElement) ||
          !(input instanceof HTMLInputElement)
        ) {
          return;
        }

        const mergeButton = page.querySelector("[data-merge-button]");
        const teamRequiredMessage = page.querySelector("[data-team-required-message]");

        const updateMergeAvailability = (selectedCount) => {
          const hasSelection = selectedCount > 0;
          if (mergeButton instanceof HTMLButtonElement) {
            mergeButton.disabled = !hasSelection;
            mergeButton.setAttribute("aria-disabled", hasSelection ? "false" : "true");
          }
          if (teamRequiredMessage instanceof HTMLElement) {
            teamRequiredMessage.classList.toggle("is-hidden", hasSelection);
          }
        };

        const sync = () => {
          const values = Array.from(select.selectedOptions).map((option) => option.value);
          input.value = values.join(",");
          updateMergeAvailability(values.length);
        };
        select.addEventListener("change", sync);
        form.addEventListener("submit", sync);
        sync();

        const toggles = page.querySelectorAll("[data-flag-toggle]");
        toggles.forEach((toggle) => {
          if (!(toggle instanceof HTMLElement)) {
            return;
          }
          const targetId = toggle.getAttribute("data-flag-toggle");
          if (!targetId) {
            return;
          }
          const toggleInput = page.querySelector(`#${targetId}`);
          if (!(toggleInput instanceof HTMLInputElement)) {
            return;
          }
          const animate = () => {
            const card = toggle.closest("[data-flag-item]");
            if (!card) {
              return;
            }
            card.classList.remove("is-animating");
            void card.offsetWidth;
            card.classList.add("is-animating");
          };
          toggle.addEventListener("click", () => {
            toggleInput.disabled = !toggleInput.disabled;
            updateToggle(toggle, toggleInput);
            animate();
          });
          updateToggle(toggle, toggleInput);
        });

        const overlapTeamToggles = page.querySelectorAll("[data-overlap-team-toggle]");
        overlapTeamToggles.forEach((toggle) => {
          if (!(toggle instanceof HTMLButtonElement)) {
            return;
          }
          toggle.addEventListener("click", () => {
            const card = toggle.closest("[data-overlap-team-card]");
            if (!(card instanceof HTMLElement)) {
              return;
            }
            const isOpen = card.classList.toggle("is-open");
            toggle.setAttribute("aria-expanded", isOpen ? "true" : "false");
          });
        });

        const overlapMoreToggle = page.querySelector("[data-overlap-more-toggle]");
        const overlapMoreList = page.querySelector("[data-overlap-more-list]");
        if (overlapMoreToggle instanceof HTMLButtonElement && overlapMoreList instanceof HTMLElement) {
          overlapMoreToggle.addEventListener("click", () => {
            const isExpanded = overlapMoreToggle.getAttribute("aria-expanded") === "true";
            overlapMoreToggle.setAttribute("aria-expanded", isExpanded ? "false" : "true");
            overlapMoreList.hidden = isExpanded;
            overlapMoreToggle.textContent = isExpanded ? "More" : "Less";
          });
        }

        const graphEntities = Array.from(
          page.querySelectorAll(".team-graph-graph-entity[data-team]"),
        ).filter((node) => node instanceof HTMLElement);
        const teamNames = Array.from(
          new Set(
            graphEntities
              .map((node) => node.getAttribute("data-team") || "")
              .map((value) => value.trim())
              .filter((value) => value.length > 0),
          ),
        ).sort((left, right) => left.localeCompare(right));
        const teamHueByName = new Map();
        teamNames.forEach((teamName, index) => {
          teamHueByName.set(teamName, Math.round((index * 137.508) % 360));
        });
        graphEntities.forEach((node) => {
          const teamName = (node.getAttribute("data-team") || "").trim();
          if (!teamName) {
            return;
          }
          const hue = teamHueByName.get(teamName);
          if (typeof hue !== "number") {
            return;
          }
          const shouldColorize =
            node.getAttribute("data-colorize-team") === "true" ||
            !!node.closest(".team-graph-graphs-item.is-merged");
          if (!shouldColorize) {
            node.style.removeProperty("--team-chip-border");
            node.style.removeProperty("--team-chip-bg");
            node.style.removeProperty("--team-chip-team-bg");
            node.style.removeProperty("--team-chip-team-text");
            return;
          }
          node.style.setProperty("--team-chip-border", `hsla(${hue}, 82%, 66%, 0.45)`);
          node.style.setProperty("--team-chip-bg", `hsla(${hue}, 80%, 44%, 0.12)`);
          node.style.setProperty("--team-chip-team-bg", `hsla(${hue}, 88%, 62%, 0.24)`);
          node.style.setProperty("--team-chip-team-text", `hsl(${hue} 100% 85%)`);
        });

        page.dataset.initialized = "true";
      };

      document.addEventListener("DOMContentLoaded", initTeamGraphPage);
      document.body.addEventListener("htmx:afterSwap", (event) => {
        if (!(event.target instanceof HTMLElement)) {
          return;
        }
        if (event.target.id !== "team-graph-page") {
          return;
        }
        initTeamGraphPage();
      });
      initTeamGraphPage();
    })();
  </script>
{% endblock %}

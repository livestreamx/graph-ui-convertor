{% extends "base.html" %}

{% block content %}
  <section class="group cross-team-group">
    <div class="group-header">
      <div>
        <div class="group-title">{{ t("Cross-team graph analytics") }}</div>
        <div class="group-count">{{ t("Get high-level graph analytics across multiple domain teams") }}</div>
      </div>
      <a class="primary-button" href="/catalog/teams/graph?lang={{ lang }}">{{ t("Open builder") }}</a>
    </div>
  </section>

  <section class="controls">
    <form
      class="search-bar"
      data-token-search="true"
      hx-get="/catalog"
      hx-target="#catalog-list"
      hx-push-url="true"
      hx-trigger="submit, change from:select"
    >
      <input
        type="search"
        name="q"
        value="{{ query }}"
        placeholder="{{ t('Type a filter and press Enter') }}"
        autocomplete="off"
      />
      <div class="search-help" role="note">
        {{ t("Press Enter to add a filter token. Tokens are combined with AND and search by title, tags, markup type, procedure_id, and block_id.") }}
      </div>
      <div class="search-token-row" data-search-token-list>
        {% for token in search_tokens %}
          <button
            type="button"
            class="search-token"
            data-remove-token="{{ token | lower }}"
            aria-label="{{ t('Remove filter') }}"
          >
            <span>{{ token }}</span>
            <span class="search-token-remove" aria-hidden="true">×</span>
          </button>
        {% endfor %}
      </div>
      <div data-search-token-hidden>
        {% for token in search_tokens %}
          <input type="hidden" name="search" value="{{ token }}" data-search-token="{{ token | lower }}" />
        {% endfor %}
      </div>
      <input type="hidden" name="lang" value="{{ lang }}" />
      <div class="filter-controls">
        <label class="filter-control">
          <span>{{ t("Criticality level") }}</span>
          <select name="criticality_level">
            <option value="">{{ t("All levels") }}</option>
            {% for level in criticality_levels %}
              <option value="{{ level }}" {% if criticality_level == level %}selected{% endif %}>
                {{ level | humanize_text }}
              </option>
            {% endfor %}
          </select>
        </label>
        <label class="filter-control">
          <span>{{ t("Team") }}</span>
          <select name="team_id">
            <option value="">{{ t("All teams") }}</option>
            {% for team_key, team_label in team_options %}
              <option value="{{ team_key }}" {% if team_id == team_key %}selected{% endif %}>
                {{ team_label }}
              </option>
            {% endfor %}
          </select>
        </label>
      </div>
      {% for field, value in group_filters.items() %}
        <input type="hidden" name="group" value="{{ field }}:{{ value }}" />
      {% endfor %}
    </form>
    <div class="filters">
      {% if active_filters %}
        <div class="filter-label">{{ t("Active filters") }}</div>
        <div class="filter-row">
          {% for filter in active_filters %}
            <span class="filter-pill">
              {{ filter.field | humanize_text }}: {{ filter.display_value | humanize_text }}
            </span>
          {% endfor %}
          <a class="ghost-button" href="/catalog?lang={{ lang }}{% for token in search_tokens %}&search={{ token | urlencode }}{% endfor %}">{{ t("Clear filters") }}</a>
        </div>
      {% endif %}
    </div>

  </section>

  <div id="catalog-list">
    {% include "catalog_list.html" %}
  </div>

  <script>
    (() => {
      const form = document.querySelector("[data-token-search='true']");
      if (!form) return;
      const input = form.querySelector("input[name='q']");
      const tokenList = form.querySelector("[data-search-token-list]");
      const hiddenContainer = form.querySelector("[data-search-token-hidden]");
      if (!input || !tokenList || !hiddenContainer) return;

      const normalize = (value) => value.trim().replace(/\s+/g, " ");
      const buildKey = (value) => normalize(value).toLowerCase();

      const tokenExists = (tokenKey) =>
        hiddenContainer.querySelector(`[data-search-token="${CSS.escape(tokenKey)}"]`) !== null;

      const appendToken = (value) => {
        const normalized = normalize(value);
        if (!normalized) return;
        const tokenKey = buildKey(normalized);
        if (!tokenKey || tokenExists(tokenKey)) return;

        const tokenButton = document.createElement("button");
        tokenButton.type = "button";
        tokenButton.className = "search-token";
        tokenButton.dataset.removeToken = tokenKey;
        tokenButton.setAttribute("aria-label", "{{ t('Remove filter') }}");

        const tokenText = document.createElement("span");
        tokenText.textContent = normalized;
        tokenButton.appendChild(tokenText);

        const tokenRemove = document.createElement("span");
        tokenRemove.className = "search-token-remove";
        tokenRemove.setAttribute("aria-hidden", "true");
        tokenRemove.textContent = "×";
        tokenButton.appendChild(tokenRemove);
        tokenList.appendChild(tokenButton);

        const hiddenInput = document.createElement("input");
        hiddenInput.type = "hidden";
        hiddenInput.name = "search";
        hiddenInput.value = normalized;
        hiddenInput.dataset.searchToken = tokenKey;
        hiddenContainer.appendChild(hiddenInput);
      };

      const removeToken = (tokenKey) => {
        const hiddenInput = hiddenContainer.querySelector(
          `[data-search-token="${CSS.escape(tokenKey)}"]`
        );
        if (hiddenInput) hiddenInput.remove();
        const tokenButton = tokenList.querySelector(
          `[data-remove-token="${CSS.escape(tokenKey)}"]`
        );
        if (tokenButton) tokenButton.remove();
      };

      input.addEventListener("keydown", (event) => {
        if (event.key !== "Enter") return;
        event.preventDefault();
        const value = normalize(input.value);
        if (value) appendToken(value);
        input.value = "";
        form.requestSubmit();
      });

      tokenList.addEventListener("click", (event) => {
        const target = event.target instanceof Element ? event.target : null;
        const tokenButton = target ? target.closest("[data-remove-token]") : null;
        if (!tokenButton) return;
        const tokenKey = tokenButton.getAttribute("data-remove-token");
        if (!tokenKey) return;
        removeToken(tokenKey);
        form.requestSubmit();
      });
    })();
  </script>
{% endblock %}

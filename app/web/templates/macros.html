{% macro render_group(group, group_query_base) %}
  <section class="group">
    <div class="group-header">
      <div>
        <div class="group-title">
          {{ group.field | humanize_text }}: {{ group.display_value | humanize_text }}
        </div>
        <div class="group-count">{{ group.count }} {{ t("scenes") }}</div>
      </div>
      <a
        class="group-filter"
        href="/catalog?lang={{ lang }}{% if group_query_base %}&{{ group_query_base }}{% endif %}&group={{ group.field | urlencode }}:{{ group.value | urlencode }}"
      >
        {{ t("Filter") }}
      </a>
    </div>
    {% if group.children %}
      <div class="group-children">
        {% for child in group.children %}
          {{ render_group(child, group_query_base) }}
        {% endfor %}
      </div>
    {% else %}
      <div class="card-grid">
        {% for item in group.items %}
          <article class="card">
            <div class="card-body">
              <div class="card-title">{{ item.title }}</div>
              <div class="card-meta">
                <span>
                  {{ "markup_type" | humanize_text }}: {{ item.markup_type | humanize_text }}
                </span>
                <span>{{ t("Updated") }} {{ item.updated_at | msk_datetime }}</span>
              </div>
              {% set item_health = health_by_scene.get(item.scene_id) %}
              {% if item_health %}
                <div class="health-marker-row">
                  <div
                    class="health-marker health-marker-graphs {% if item_health.graph.is_problem %}is-problem is-glow{% endif %}"
                    data-health-marker="graphs"
                  >
                    <span class="health-marker-label">{{ t("Graphs") }}</span>
                    <span class="health-marker-value">{{ item_health.graph.unique_graph_count }}</span>
                  </div>
                  <div
                    class="health-marker health-marker-same-team {% if item_health.same_team_similarity.is_problem %}is-problem is-glow{% endif %}"
                    data-health-marker="same-team"
                  >
                    <span class="health-marker-label">{{ t("Team overlap") }}</span>
                    <span class="health-marker-value">
                      {% if item_health.same_team_similarity.top_match %}
                        {{ "%.1f"|format(item_health.same_team_similarity.top_match.overlap_percent) }}%
                      {% else %}
                        0.0%
                      {% endif %}
                    </span>
                  </div>
                  <div
                    class="health-marker health-marker-cross-team {% if item_health.cross_team_similarity.is_problem %}is-problem is-glow{% endif %}"
                    data-health-marker="cross-team"
                  >
                    <span class="health-marker-label">{{ t("Cross-team overlap") }}</span>
                    <span class="health-marker-value">
                      {% if item_health.cross_team_similarity.top_match %}
                        {{ "%.1f"|format(item_health.cross_team_similarity.top_match.overlap_percent) }}%
                      {% else %}
                        0.0%
                      {% endif %}
                    </span>
                  </div>
                  <div
                    class="health-marker health-marker-gaming {% if item_health.gaming.is_problem %}is-problem is-glow{% endif %}"
                    data-health-marker="gaming"
                  >
                    <span class="health-marker-label">{{ t("Gaming validity") }}</span>
                    <span class="health-marker-value">
                      {{ item_health.gaming.branch_block_count }}/{{ item_health.gaming.non_postpone_end_block_count }}
                    </span>
                  </div>
                </div>
                {% if item_health.graph.issue_codes %}
                  {% set issue_code = item_health.graph.issue_codes[0] %}
                  <div class="card-health-note">
                    {{ t(graph_issue_text_keys.get(issue_code, issue_code)) }}
                    {% if item_health.graph.issue_codes|length > 1 %}
                      +{{ item_health.graph.issue_codes|length - 1 }}
                    {% endif %}
                  </div>
                {% elif item_health.gaming.is_problem %}
                  <div class="card-health-note">
                    {{ t("No branches and no end blocks except postpone") }}
                  </div>
                {% endif %}
              {% endif %}
              {% if item.tags %}
                <div class="tag-row">
                  {% for tag in item.tags %}
                    <span class="tag">{{ tag }}</span>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
            <div class="card-actions">
              <a class="primary-button" href="/catalog/{{ item.scene_id }}?lang={{ lang }}">{{ t("View") }}</a>
            </div>
          </article>
        {% endfor %}
      </div>
    {% endif %}
  </section>
{% endmacro %}
